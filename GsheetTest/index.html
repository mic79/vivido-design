<!DOCTYPE html>
<html>

<head>
  <title>Sheets API Quickstart</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
  <p>Sheets API Quickstart</p>

  <!--Add buttons to initiate auth sequence and sign out-->
  <button id="addtest_button" onclick="handleAddtestClick()">Add test</button>
  <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
  <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
  <button onclick="execute()">execute</button>

  <pre id="content" style="white-space: pre-wrap"></pre>

  <script type="text/javascript">
    /* exported gapiLoaded */
    /* exported gisLoaded */
    /* exported handleAuthClick */
    /* exported handleSignoutClick */

    // TODO(developer): Set to client ID and API key from the Developer Console
    const CLIENT_ID = "577984121120-ep9eli0hgkign6ptb4ntf2hk490r0dgg.apps.googleusercontent.com";
    const API_KEY = "AIzaSyDHltCOaMs-972eToaVmKYVr9LVj7ugpC0";
    const APP_ID = "577984121120";

    // Discovery doc URL for APIs used by the quickstart
    const DISCOVERY_DOC =
      "https://sheets.googleapis.com/$discovery/rest?version=v4";

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    const SCOPES = "https://www.googleapis.com/auth/drive.file"; //"https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/drive.metadata.readonly"; //'https://www.googleapis.com/auth/drive.metadata.readonly';// https://www.googleapis.com/auth/drive.file'; //'https://www.googleapis.com/auth/spreadsheets.readonly';

    let tokenClient;
    let accessToken = null;
    let gapiInited = false;
    let gisInited = false;
    let pickerInited = false;
    let fileId;

    document.getElementById("addtest_button").style.visibility = "hidden";
    document.getElementById("authorize_button").style.visibility = "hidden";
    document.getElementById("signout_button").style.visibility = "hidden";

    /**
     * Callback after api.js is loaded.
     */
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
      gapi.load("client:picker", initializePicker);
    }

    /**
     * Callback after the API client is loaded. Loads the
     * discovery doc to initialize the API.
     */
    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    /**
     * Callback after Google Identity Services are loaded.
     */
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: "", // defined later
      });
      gisInited = true;
      maybeEnableButtons();
    }

    /**
     * Callback after the API client is loaded. Loads the
     * discovery doc to initialize the API.
     */
    async function initializePicker() {
      await gapi.client.load(
        "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"
      );
      pickerInited = true;
      maybeEnableButtons();
    }

    /**
     * Enables user interaction after all libraries are loaded.
     */
    function maybeEnableButtons() {
      //if (gapiInited && gisInited && pickerInited) {
      if (gisInited && pickerInited) {
        document.getElementById("authorize_button").style.visibility =
          "visible";
      }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw resp;
        }
        accessToken = resp.access_token;
        document.getElementById("addtest_button").style.visibility =
          "visible";
        document.getElementById("signout_button").style.visibility =
          "visible";
        document.getElementById("authorize_button").innerText = "Refresh";
        //await listMajors();
        //await createSheet('GSheetTest');
        //await listMajors('113AkoHNRxoqvJ3uSxRADr8QtA26w2lGZzsHgVolwtTQ');
        await createPicker();
      };

      console.log(
        ">>",
        gapi.client.getToken(),
        gapi.client.getToken() === null
      );
      if (gapi.client.getToken() === null) {
        // Prompt the user to select a Google Account and ask for consent to share their data
        // when establishing a new session.
        tokenClient.requestAccessToken({ prompt: "consent" });
      } else {
        // Skip display of account chooser and consent dialog for an existing session.
        //tokenClient.requestAccessToken({prompt: ''});
        listMajors(fileId);
      }
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick() {
      const token = gapi.client.getToken();
      if (token !== null) {
        accessToken = null;
        fileId = null;
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken("");
        document.getElementById("content").innerText = "";
        document.getElementById("addtest_button").style.visibility = "hidden";
        document.getElementById("authorize_button").innerText = "Authorize";
        document.getElementById("signout_button").style.visibility = "hidden";
      }
    }

    /**
     *  Create and render a Picker object for searching images.
     */
    function createPicker() {
      const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
      view.setMimeTypes("application/vnd.google-apps.spreadsheet");
      view.setQuery('GSheet');
      const picker = new google.picker.PickerBuilder()
        .enableFeature(google.picker.Feature.NAV_HIDDEN)
        //.enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
        .setDeveloperKey(API_KEY)
        .setAppId(APP_ID)
        .setOAuthToken(accessToken)
        .addView(view)
        .addView(new google.picker.DocsUploadView())
        .setCallback(pickerCallback)
        .build();
      picker.setVisible(true);
    }

    /**
     * Displays the file details of the user's selection.
     * @param {object} data - Containers the user selection from the picker
     */
    async function pickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        let text = `Picker response: \n${JSON.stringify(data, null, 2)}\n`;
        const document = data[google.picker.Response.DOCUMENTS][0];
        fileId = document[google.picker.Document.ID];
        console.log(fileId);
        /*const res = await gapi.client.drive.files.get({
          fileId: fileId,
          fields: "*",
        });
        text += `Drive API response for first document: \n${JSON.stringify(
          res.result,
          null,
          2
        )}\n`;
        window.document.getElementById("content").innerText = text;*/
        await listMajors(fileId);
      }
    }

    /**
     *  Add test fields upon button click.
     */
    function handleAddtestClick() {
      appendValues(
        fileId,
        "Sheet1!A1:E1",
        "USER_ENTERED"
      );
    }

    /* Create new Google Sheet */
    async function createSheet(title, callback) {
      try {
        gapi.client.sheets.spreadsheets
          .create({
            properties: {
              title: title,
            },
          })
          .then((response) => {
            if (callback) callback(response);
            console.log("Spreadsheet ID: " + response.result.spreadsheetId);
            listMajors(response.result.spreadsheetId);
          });
      } catch (err) {
        document.getElementById("content").innerText = err.message;
        return;
      }
    }

    /* Append test values */
    function appendValues(
      spreadsheetId,
      range,
      valueInputOption,
      _values,
      callback
    ) {
      let values = [
        ["Test", "", "", "", "Testing", ""],
        // Additional rows ...
      ];
      if (_values) {
        values = _values;
      }
      const body = {
        values: values,
        majorDimension: "ROWS",
      };
      try {
        gapi.client.sheets.spreadsheets.values
          .append({
            spreadsheetId: spreadsheetId,
            range: range,
            valueInputOption: valueInputOption,
            resource: body,
          })
          .then((response) => {
            const result = response.result;
            console.log(`${result.updates.updatedCells} cells appended.`);
            listMajors(fileId);
            if (callback) callback(response);
          });
      } catch (err) {
        document.getElementById("content").innerText = err.message;
        return;
      }
    }

    /**
     * Print the names and majors of students in a sample spreadsheet:
     * https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
     */
    async function listMajors(newspreadsheetId) {
      console.log('listMajors', newspreadsheetId);
      let response;
      try {
        // Fetch first 10 files
        /*response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '1YEM_Vm2_BSbg3JJQZQgprVsiaxdZxXOUYMKIK2v2uRo',
          range: 'Class Data!A2:E',
        });*/
        response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: newspreadsheetId,
          range: "Sheet1!A1:E",
        });
      } catch (err) {
        document.getElementById("content").innerText = err.message;
        return;
      }
      const range = response.result;
      if (!range || !range.values || range.values.length == 0) {
        document.getElementById("content").innerText = "No values found.";
        return;
      }
      // Flatten to string to display
      const output = range.values.reduce(
        (str, row) => `${str}${row[0]}, ${row[4]}\n`,
        "Name, Major:\n"
      );
      document.getElementById("content").innerText = output;
    }

    /*!
    * JavaScript UUID Generator, v0.0.1
    *
    * Copyright (c) 2009 Massimo Lombardo.
    * Dual licensed under the MIT and the GNU GPL licenses.
    */
    function uuid4() {
      var uuid = (function () {
        var i,
          c = "89ab",
          u = [];
        for (i = 0; i < 36; i += 1) {
          u[i] = (Math.random() * 16 | 0).toString(16);
        }
        u[8] = u[13] = u[18] = u[23] = "-";
        u[14] = "4";
        u[19] = c.charAt(Math.random() * 4 | 0);
        return u.join("");
      })();
      return {
        toString: function () {
          return uuid;
        },
        valueOf: function () {
          return uuid;
        }
      };
    }

    /* TEST: Initiate files.watch */
    function execute() {
      let uuid = uuid4().toString();
      return gapi.client.drive.changes.watch({
        "fileId": fileId,
        "resource": {
          "id": uuid, // Your channel ID.
          "type": "web_hook",
          "address": "https://vivido-design.com/GSheetTest/notifications", // Your receiving URL.
          //"token": gapi.client.getToken(), // (Optional) Your files channel token.
          //"expiration": 1426325213000 // (Optional) Your requested channel expiration date and time.
        }
      })
        .then(function (response) {
          // Handle the results here (response.result has the parsed body).
          console.log("Response", response);
        },
          function (err) { console.error("Execute error", err); });
    }
  </script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>

</html>