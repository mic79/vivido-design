<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dutch Language Meetup VR</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- CSS3DRenderer loaded after A-Frame, will use A-Frame's bundled THREE -->
  <script src="https://unpkg.com/three@0.147.0/examples/js/renderers/CSS3DRenderer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vosk-browser@0.0.8/dist/vosk.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* CSS3D UI Elements (will be rendered in 3D space) */
    .css3d-element {
      background: rgba(20, 20, 40, 0.95);
      border: 2px solid rgba(100, 150, 255, 0.6);
      border-radius: 15px;
      padding: 30px;
      color: white;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
    }

    /* Question Display */
    #question-box {
      width: 800px;
      height: 200px;
    }

    #question-dutch {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 15px;
      line-height: 1.4;
      color: #ffffff;
    }

    #question-english {
      font-size: 20px;
      font-style: italic;
      color: #88aaff;
      opacity: 0;
      transition: opacity 0.3s;
      margin-top: 10px;
    }

    #question-box:hover #question-english {
      opacity: 1;
    }

    .repeat-btn {
      background: rgba(100, 150, 255, 0.4);
      border: 2px solid rgba(100, 150, 255, 0.8);
      color: white;
      padding: 12px 30px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      margin-top: 15px;
      transition: all 0.3s;
    }

    .repeat-btn:hover {
      background: rgba(100, 150, 255, 0.7);
      transform: scale(1.05);
    }

    /* Answer Choices Container */
    #answer-choices {
      width: 1400px;
      display: flex;
      gap: 30px;
      justify-content: center;
    }

    .answer-card {
      background: rgba(30, 30, 60, 0.95);
      border: 2px solid rgba(80, 120, 200, 0.6);
      border-radius: 12px;
      padding: 30px;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
      min-width: 300px;
    }

    .answer-card:hover {
      background: rgba(50, 70, 120, 0.95);
      border-color: rgba(100, 150, 255, 0.9);
      transform: scale(1.05);
      box-shadow: 0 10px 40px rgba(100, 150, 255, 0.4);
    }

    .answer-dutch {
      color: #ffffff;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .answer-english {
      color: #88aaff;
      font-size: 18px;
      font-style: italic;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .answer-card:hover .answer-english {
      opacity: 1;
    }

    /* Mic Visualizer */
    #mic-container {
      width: 600px;
      display: none;
      flex-direction: column;
      align-items: center;
      background: rgba(20, 20, 40, 0.95);
      border: 2px solid rgba(255, 50, 100, 0.6);
      border-radius: 15px;
      padding: 20px;
    }

    #mic-container.active {
      display: flex;
    }

    #visualizer {
      width: 500px;
      height: 200px;
      background: rgba(10, 10, 20, 0.8);
      border-radius: 10px;
      padding: 10px;
    }

    #visualizer path {
      stroke: #ff3366;
      stroke-width: 2;
      fill: none;
    }

    #mic-status {
      color: #ff3366;
      font-size: 20px;
      font-weight: 700;
      margin-top: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* Recognition Result */
    #recognition-result {
      width: 700px;
      background: rgba(20, 60, 20, 0.95);
      border: 2px solid rgba(100, 255, 100, 0.6);
      border-radius: 12px;
      padding: 30px;
      display: none;
      text-align: center;
    }

    #recognition-result.show {
      display: block;
    }

    #recognized-text {
      color: #ffffff;
      font-size: 24px;
      margin-bottom: 15px;
    }

    #accuracy-score {
      color: #88ff88;
      font-size: 32px;
      font-weight: bold;
    }

    /* Final Score */
    #final-score {
      width: 800px;
      background: rgba(20, 20, 40, 0.98);
      border: 3px solid rgba(255, 215, 0, 0.8);
      border-radius: 20px;
      padding: 50px;
      display: none;
      text-align: center;
    }

    #final-score.show {
      display: block;
    }

    #final-score h2 {
      color: #ffd700;
      font-size: 40px;
      margin-bottom: 25px;
    }

    #total-accuracy {
      color: #ffffff;
      font-size: 56px;
      font-weight: bold;
      margin: 25px 0;
    }

    #best-score {
      color: #88aaff;
      font-size: 22px;
      margin-top: 20px;
    }

    #restart-btn {
      background: rgba(100, 150, 255, 0.6);
      border: 2px solid rgba(100, 150, 255, 1);
      color: white;
      padding: 20px 50px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 22px;
      margin-top: 25px;
      transition: all 0.3s;
    }

    #restart-btn:hover {
      background: rgba(100, 150, 255, 0.9);
      transform: scale(1.1);
    }

    /* Instructions */
    #instructions {
      width: 1000px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 18px;
      text-align: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 15px 30px;
      border-radius: 10px;
    }

    /* Loading Screen */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      transition: opacity 0.5s;
    }

    #loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    #loading-text {
      color: white;
      font-size: 24px;
      margin-top: 20px;
    }

    #loading-error {
      color: #ff6b6b;
      font-size: 18px;
      margin-top: 15px;
      max-width: 600px;
      text-align: center;
      line-height: 1.6;
    }

    #mic-help {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      margin-top: 15px;
      max-width: 500px;
      text-align: left;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      line-height: 1.5;
    }

    #mic-help strong {
      color: white;
    }

    #retry-btn {
      background: rgba(100, 150, 255, 0.8);
      border: 2px solid rgba(100, 150, 255, 1);
      color: white;
      padding: 15px 40px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      margin-top: 20px;
      transition: all 0.3s;
    }

    #retry-btn:hover {
      background: rgba(100, 150, 255, 1);
      transform: scale(1.05);
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen">
    <div class="spinner"></div>
    <div id="loading-text">Loading Dutch Language Model...</div>
    <div id="loading-error" style="display: none;"></div>
    <div id="mic-help" style="display: none;">
      <strong>How to enable microphone:</strong><br>
      ‚Ä¢ <strong>Quest Browser:</strong> Tap "Allow" when prompted<br>
      ‚Ä¢ <strong>Chrome/Edge:</strong> Click the üîí or üé§ icon in the address bar<br>
      ‚Ä¢ <strong>Firefox:</strong> Click the üõà icon ‚Üí Permissions ‚Üí Microphone ‚Üí Allow<br>
      ‚Ä¢ Then click "Retry" below
    </div>
    <button id="retry-btn" style="display: none;" onclick="DutchApp.retryInit()">üîÑ Retry</button>
  </div>

  <!-- CSS3D UI Elements (hidden containers, will be positioned in 3D) -->
  <div id="css3d-container" style="position: absolute; top: 0; left: 0; pointer-events: none;">
    <!-- Start Button -->
    <div id="start-button" class="css3d-element">
      <h2 style="font-size: 48px; margin-bottom: 20px;">üá≥üá± Dutch Language Practice</h2>
      <p style="font-size: 24px; margin-bottom: 30px;">Learn Dutch through conversation with Maria</p>
      <button class="repeat-btn clickable" onclick="window.DutchApp.startExperience()" style="font-size: 32px; padding: 20px 60px;">
        ‚ñ∂Ô∏è Start Conversation
      </button>
    </div>

    <!-- Question Display -->
    <div id="question-box" class="css3d-element" style="display: none;">
      <div id="question-dutch">Hallo! Hoe gaat het met je?</div>
      <div id="question-english">Hello! How are you?</div>
      <button class="repeat-btn clickable" onclick="window.DutchApp.repeatQuestion()">üîä Repeat</button>
    </div>

    <!-- Answer Choices -->
    <div id="answer-choices" class="css3d-element" style="display: none;">
      <!-- Dynamically populated -->
    </div>

    <!-- Mic Visualizer -->
    <div id="mic-container" class="css3d-element">
      <svg id="visualizer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 255 255">
        <defs>
          <mask id="mask">
            <g id="maskGroup"></g>
          </mask>
        </defs>
        <rect x="0" y="0" width="255" height="255" fill="#ff3366" mask="url(#mask)" opacity="0.7"></rect>
      </svg>
      <div id="mic-status">üé§ Listening...</div>
    </div>

    <!-- Recognition Result -->
    <div id="recognition-result" class="css3d-element">
      <div id="recognized-text">You said: "..."</div>
      <div id="accuracy-score">85% Match</div>
    </div>

    <!-- Final Score -->
    <div id="final-score" class="css3d-element">
      <h2>üéâ Conversation Complete!</h2>
      <div id="total-accuracy">87%</div>
      <div>Overall Accuracy</div>
      <div id="best-score">Personal Best: 87%</div>
      <button id="restart-btn" class="clickable" onclick="window.DutchApp.restart()">üîÑ Try Again</button>
    </div>

    <!-- Instructions -->
    <div id="instructions" class="css3d-element">
      Hold controller trigger to speak ‚Ä¢ Hover to see translations
    </div>
  </div>

  <!-- A-Frame VR Scene -->
  <a-scene background="color: #87CEEB" renderer="antialias: true; colorManagement: true">
    <!-- Assets -->
    <a-assets>
      <!-- Environment model (language meetup setting) -->
      <a-asset-item id="cafe-model" src="assets/library_of_celsus_-_crowdsourced_photogrammetry.glb"></a-asset-item>
    </a-assets>

    <!-- Camera Rig with Hands -->
    <a-entity id="camera-rig" position="0 0 0">
      <!-- Camera at eye level -->
      <a-entity 
        id="camera" 
        camera 
        look-controls="pointerLockEnabled: false"
        position="0 1.6 0">
      </a-entity>
      
      <!-- Hands and Controllers (attached to rig so they follow camera) -->
      <a-entity id="left-hand" 
                hand-controls="hand: left; handModelStyle: lowPoly; color: #15ACCF">
      </a-entity>
      <a-entity id="right-hand" 
                hand-controls="hand: right; handModelStyle: lowPoly; color: #15ACCF" 
                laser-controls="hand: right" 
                raycaster="objects: .clickable; far: 10; lineColor: red; lineOpacity: 0.5">
      </a-entity>
    </a-entity>

    <!-- Environment (smaller scale, behind user so it's a backdrop) -->
    <a-entity id="environment" position="0 0 10" scale="1 1 1" rotation="0 180 0">
      <a-entity gltf-model="#cafe-model" position="0 0 0"></a-entity>
    </a-entity>

    <!-- Lighting -->
    <a-entity light="type: ambient; color: #BBB; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="5 10 5"></a-entity>
    <a-entity light="type: point; color: #FFD700; intensity: 0.5" position="-5 5 -5"></a-entity>

    <!-- Ground -->
    <a-plane position="0 0 0" rotation="-90 0 0" width="100" height="100" color="#7BC8A4" shadow="receive: true"></a-plane>

    <!-- NPC Avatar - Maria (in front of user) -->
    <a-entity id="npc" position="0 1.3 -2.5">
      <!-- Head -->
      <a-sphere position="0 0.3 0" radius="0.15" color="#FFD4A3"></a-sphere>
      <!-- Body -->
      <a-cylinder position="0 0 0" radius="0.12" height="0.5" color="#4A90E2"></a-cylinder>
      <!-- Arms -->
      <a-cylinder position="-0.2 0.05 0" radius="0.04" height="0.4" rotation="0 0 20" color="#FFD4A3"></a-cylinder>
      <a-cylinder position="0.2 0.05 0" radius="0.04" height="0.4" rotation="0 0 -20" color="#FFD4A3"></a-cylinder>
      <!-- Name label above head -->
      <a-entity position="0 0.6 0">
        <a-text value="Maria" align="center" color="#ffffff" width="1.5"></a-text>
      </a-entity>
    </a-entity>

    <!-- UI Panels (A-Frame entities, always visible) -->
    <!-- Start Button -->
    <a-entity id="ui-start" position="0 1.6 -1.8" visible="true">
      <a-plane width="1.5" height="0.6" color="#1a1a2e" opacity="0.9">
        <a-text value="Start Conversation" align="center" color="#ffffff" width="1.3" position="0 0.1 0.01"></a-text>
        <a-text value="Click to Begin" align="center" color="#88aaff" width="1" position="0 -0.1 0.01"></a-text>
      </a-plane>
      <a-box class="clickable" width="1.5" height="0.6" depth="0.01" opacity="0" position="0 0 0"></a-box>
    </a-entity>

    <!-- Question Panel -->
    <a-entity id="ui-question" position="0 2.2 -2.5" visible="false">
      <a-plane width="2" height="0.5" color="#1a1a2e" opacity="0.9">
        <a-text id="question-text-nl" value="Hoe gaat het?" align="center" color="#ffffff" width="1.8" position="0 0 0.01"></a-text>
      </a-plane>
      <!-- English translation - hidden by default, shown on hover -->
      <a-text id="question-text-en" value="(How are you?)" align="center" color="#88aaff" width="1.6" position="0 -0.3 0.01" visible="false"></a-text>
    </a-entity>

    <!-- Answer Panel 1 -->
    <a-entity id="ui-answer1" position="-1 1 -2" visible="false">
      <a-plane class="clickable answer-card" width="0.8" height="0.4" color="#2a2a4e" opacity="0.9">
        <a-text id="answer1-text" value="Goed" align="center" color="#ffffff" width="0.7" position="0 0.05 0.01"></a-text>
        <a-text id="answer1-en" value="(Good)" align="center" color="#88aaff" width="0.6" position="0 -0.1 0.01" visible="false"></a-text>
      </a-plane>
    </a-entity>

    <!-- Answer Panel 2 -->
    <a-entity id="ui-answer2" position="0 1 -2" visible="false">
      <a-plane class="clickable answer-card" width="0.8" height="0.4" color="#2a2a4e" opacity="0.9">
        <a-text id="answer2-text" value="Prima" align="center" color="#ffffff" width="0.7" position="0 0.05 0.01"></a-text>
        <a-text id="answer2-en" value="(Fine)" align="center" color="#88aaff" width="0.6" position="0 -0.1 0.01" visible="false"></a-text>
      </a-plane>
    </a-entity>

    <!-- Answer Panel 3 -->
    <a-entity id="ui-answer3" position="1 1 -2" visible="false">
      <a-plane class="clickable answer-card" width="0.8" height="0.4" color="#2a2a4e" opacity="0.9">
        <a-text id="answer3-text" value="Heel goed" align="center" color="#ffffff" width="0.7" position="0 0.05 0.01"></a-text>
        <a-text id="answer3-en" value="(Very good)" align="center" color="#88aaff" width="0.6" position="0 -0.1 0.01" visible="false"></a-text>
      </a-plane>
    </a-entity>

    <!--Microphone Visualizer (visible when listening) -->
    <a-entity id="ui-mic-viz" position="0 1.5 -2" visible="false">
      <a-plane width="2" height="0.6" color="#000000" opacity="0.8">
        <a-text value="üé§ Listening..." align="center" color="#ff0000" width="1.8" position="0 0.2 0.01"></a-text>
        <!-- Visual bars for audio levels (will be animated by AudioVisualizer) -->
        <a-entity id="viz-bars" position="-0.4 -0.1 0.02">
          <!-- 8 bars for simple visualization -->
          <a-box id="viz-bar-0" width="0.08" height="0.05" depth="0.01" color="#ff3366" position="0 0 0"></a-box>
          <a-box id="viz-bar-1" width="0.08" height="0.05" depth="0.01" color="#ff3366" position="0.1 0 0"></a-box>
          <a-box id="viz-bar-2" width="0.08" height="0.05" depth="0.01" color="#ff3366" position="0.2 0 0"></a-box>
          <a-box id="viz-bar-3" width="0.08" height="0.05" depth="0.01" color="#ff3366" position="0.3 0 0"></a-box>
          <a-box id="viz-bar-4" width="0.08" height="0.05" depth="0.01" color="#ff3366" position="0.4 0 0"></a-box>
          <a-box id="viz-bar-5" width="0.08" height="0.05" depth="0.01" color="#ff3366" position="0.5 0 0"></a-box>
          <a-box id="viz-bar-6" width="0.08" height="0.05" depth="0.01" color="#ff3366" position="0.6 0 0"></a-box>
          <a-box id="viz-bar-7" width="0.08" height="0.05" depth="0.01" color="#ff3366" position="0.7 0 0"></a-box>
        </a-entity>
      </a-plane>
    </a-entity>

    <!-- Recognition Result (shown after speech recognition) -->
    <a-entity id="ui-recognition-result" position="0 1.8 -2.5" visible="false">
      <a-plane width="2.5" height="0.8" color="#1a1a2e" opacity="0.9">
        <a-text id="recognition-text" value="You said: ..." align="center" color="#ffffff" width="2.3" position="0 0.15 0.01"></a-text>
        <a-text id="accuracy-text" value="Accuracy: 0%" align="center" color="#4CAF50" width="2.3" position="0 -0.15 0.01"></a-text>
      </a-plane>
    </a-entity>

    <!-- Final Score (shown at end of conversation) -->
    <a-entity id="ui-final-score" position="0 1.8 -2.5" visible="false">
      <a-plane width="2.5" height="1.5" color="#1a1a2e" opacity="0.9">
        <a-text value="üéâ Conversation Complete!" align="center" color="#ffffff" width="2.2" position="0 0.55 0.01"></a-text>
        <a-text id="final-accuracy-text" value="Overall Accuracy: 0%" align="center" color="#4CAF50" width="2.2" position="0 0.2 0.01"></a-text>
        <a-text id="best-score-text" value="Personal Best: 0%" align="center" color="#FFD700" width="2.2" position="0 -0.1 0.01"></a-text>
        <!-- Restart Button -->
        <a-entity id="restart-button" position="0 -0.5 0.01">
          <a-plane class="clickable" width="1" height="0.35" color="#4A90E2" opacity="0.9">
            <a-text value="üîÑ Try Again" align="center" color="#ffffff" width="0.9" position="0 0 0.01"></a-text>
          </a-plane>
        </a-entity>
      </a-plane>
    </a-entity>

    <!-- Instructions -->
    <a-entity id="ui-instructions" position="0 0.5 -2" visible="true">
      <a-text value="Hold trigger to speak" align="center" color="#ffffff" width="1.5"></a-text>
    </a-entity>

    <!-- Sky -->
    <a-sky color="#87CEEB"></a-sky>
  </a-scene>

  <script>
    // ============================================
    // WAIT FOR A-FRAME AND ENSURE THREE.js IS AVAILABLE
    // ============================================
    
    // CSS3DRenderer uses the global THREE from A-Frame
    // A-Frame includes THREE.js, so we don't need to load it separately
    
    // ============================================
    // CSS3D RENDERER INTEGRATION WITH A-FRAME
    // ============================================
    AFRAME.registerComponent('css3d-ui', {
      init: function () {
        console.log('[CSS3D] Initializing CSS3D renderer...');
        
        // Ensure THREE is available (from A-Frame)
        if (typeof THREE === 'undefined') {
          console.error('[CSS3D] THREE.js not found! A-Frame should provide it.');
          return;
        }
        
        // Ensure CSS3DRenderer is available
        if (typeof THREE.CSS3DRenderer === 'undefined') {
          console.error('[CSS3D] CSS3DRenderer not loaded!');
          return;
        }
        
        const sceneEl = this.el.sceneEl;
        const rendererEl = sceneEl.renderer;
        
        // Create CSS3DRenderer
        this.css3dRenderer = new THREE.CSS3DRenderer();
        this.css3dRenderer.setSize(window.innerWidth, window.innerHeight);
        this.css3dRenderer.domElement.style.position = 'absolute';
        this.css3dRenderer.domElement.style.top = '0';
        this.css3dRenderer.domElement.style.pointerEvents = 'none';
        
        // Insert CSS3D canvas above A-Frame canvas
        const aframeCanvas = sceneEl.canvas;
        aframeCanvas.parentNode.insertBefore(this.css3dRenderer.domElement, aframeCanvas);
        
        // Create CSS3D scene (separate from A-Frame/Three.js scene)
        this.css3dScene = new THREE.Scene();
        
        // Store reference globally for easy access
        window.CSS3DUI = {
          renderer: this.css3dRenderer,
          scene: this.css3dScene,
          objects: {}
        };
        
        console.log('[CSS3D] ‚úì Renderer created');
        
        // Create UI elements in 3D space
        this.createUI();
        
        // Handle window resize
        window.addEventListener('resize', () => {
          this.css3dRenderer.setSize(window.innerWidth, window.innerHeight);
        });
      },
      
      createUI: function () {
        console.log('[CSS3D] Creating 3D UI elements...');
        
        // All UI elements in FRONT of user (negative Z in A-Frame = forward)
        // User at (0, 1.6, 0), looking toward negative Z
        
        // Start Button (center, at eye level, close)
        this.createCSS3DObject('start-button', { x: 0, y: 1.6, z: -1.5 }, 0.0012);
        
        // Question Box (above Maria's head)
        this.createCSS3DObject('question-box', { x: 0, y: 2.2, z: -2.5 }, 0.0012);
        
        // Answer Choices (below Maria, readable distance)
        this.createCSS3DObject('answer-choices', { x: 0, y: 0.9, z: -2 }, 0.001);
        
        // Mic Visualizer (bottom center, close)
        this.createCSS3DObject('mic-container', { x: 0, y: 0.7, z: -1.5 }, 0.0015);
        
        // Recognition Result (center, at eye level)
        this.createCSS3DObject('recognition-result', { x: 0, y: 1.6, z: -2 }, 0.0012);
        
        // Final Score (center, at eye level, close)
        this.createCSS3DObject('final-score', { x: 0, y: 1.6, z: -1.5 }, 0.0012);
        
        // Instructions (bottom, readable)
        this.createCSS3DObject('instructions', { x: 0, y: 0.5, z: -2 }, 0.001);
        
        console.log('[CSS3D] ‚úì UI elements created in 3D space');
      },
      
      createCSS3DObject: function (elementId, position, scale) {
        const element = document.getElementById(elementId);
        if (!element) {
          console.warn('[CSS3D] Element not found:', elementId);
          return;
        }
        
        // Create CSS3D object from HTML element
        const object = new THREE.CSS3DObject(element);
        object.position.set(position.x, position.y, position.z);
        object.scale.set(scale, scale, scale);
        
        // Add to CSS3D scene
        window.CSS3DUI.scene.add(object);
        window.CSS3DUI.objects[elementId] = object;
        
        // Initially hide all except start button
        if (elementId === 'start-button') {
          object.visible = true;
        } else {
          object.visible = false;
        }
        
        // Enable pointer events for buttons
        element.style.pointerEvents = 'auto';
        
        console.log(`[CSS3D] ‚úì Created ${elementId} at (${position.x}, ${position.y}, ${position.z})`);
      },
      
      tick: function () {
        // Render CSS3D on every frame
        if (this.css3dRenderer && this.css3dScene) {
          const camera = this.el.sceneEl.camera;
          this.css3dRenderer.render(this.css3dScene, camera);
        }
      }
    });
    
    // ============================================
    // STRING SIMILARITY HELPER (Levenshtein Distance)
    // ============================================
    function calculateSimilarity(str1, str2) {
      // Normalize strings: lowercase, remove punctuation, trim
      const normalize = (s) => s.toLowerCase().replace(/[.,!?]/g, '').trim();
      const s1 = normalize(str1);
      const s2 = normalize(str2);
      
      // Levenshtein distance algorithm
      const matrix = [];
      const n = s1.length;
      const m = s2.length;

      if (n === 0) return m === 0 ? 100 : 0;
      if (m === 0) return 0;

      for (let i = 0; i <= n; i++) {
        matrix[i] = [i];
      }

      for (let j = 0; j <= m; j++) {
        matrix[0][j] = j;
      }

      for (let i = 1; i <= n; i++) {
        for (let j = 1; j <= m; j++) {
          const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i - 1][j] + 1,
            matrix[i][j - 1] + 1,
            matrix[i - 1][j - 1] + cost
          );
        }
      }

      const distance = matrix[n][m];
      const maxLength = Math.max(n, m);
      const similarity = ((maxLength - distance) / maxLength) * 100;
      
      return Math.round(similarity);
    }

    // ============================================
    // VOSK SPEECH RECOGNITION
    // ============================================
    const VoskRecognizer = {
      model: null,
      recognizer: null,
      audioContext: null,
      processor: null,
      analyser: null,
      microphoneStream: null,
      sourceNode: null,
      isInitialized: false,
      isListening: false,
      shouldProcessResults: false,
      onResult: null,
      onPartialResult: null,

      async init(onResult, onPartialResult) {
        console.log('[Vosk] Initializing Dutch model...');
        this.onResult = onResult;
        this.onPartialResult = onPartialResult;
        this.shouldProcessResults = false;

        try {
          const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
          const modelPath = `assets/vosk-models/nl.tar.gz`;
          const fullModelPath = `${baseUrl}/${modelPath}`;

          console.log('[Vosk] Loading model from:', fullModelPath);
          this.model = await Vosk.createModel(fullModelPath);
          console.log('[Vosk] ‚úì Model loaded');

          this.recognizer = new this.model.KaldiRecognizer(16000);
          this.recognizer.setWords(true);
          console.log('[Vosk] ‚úì Recognizer created');

          // Setup audio context
          await this.setupAudio();
          
          this.isInitialized = true;
          console.log('[Vosk] ‚úì Initialization complete');
          return true;
        } catch (error) {
          console.error('[Vosk] Initialization error:', error);
          throw error;
        }
      },

      setupRecognizerEvents() {
        // Set up event listeners for the current recognizer
        this.recognizer.on('result', (message) => {
          // Only process if we should be listening
          if (!this.shouldProcessResults || !this.recognizer) {
            console.log('[Vosk] Ignoring result - not listening');
            return;
          }
          
          console.log('[Vosk] Result event:', message);
          // Access the nested result.text property (Quest-compatible syntax)
          const text = (message.result && message.result.text) || message.text;
          if (text && text.trim()) {
            console.log('[Vosk] ‚úì Recognized:', text);
            if (this.onResult) {
              this.onResult(text);
            }
          }
        });
        
        this.recognizer.on('partialresult', (message) => {
          // Only process if we should be listening
          if (!this.shouldProcessResults || !this.recognizer) {
            return; // Silent ignore for partials
          }
          
          // Access the nested result.partial property (Quest-compatible syntax)
          const partial = (message.result && message.result.partial) || message.partial;
          if (partial && partial.trim()) {
            console.log('[Vosk] Partial:', partial);
            // Call onPartialResult callback if provided
            if (this.onPartialResult) {
              this.onPartialResult(partial);
            }
          }
        });
      },

      async setupAudio() {
        try {
          // Get microphone stream
          this.microphoneStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              sampleRate: 16000
            } 
          });
          
          console.log('[Vosk] Microphone access granted');
          
          // Create audio context with 16kHz sample rate (Vosk requirement)
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: 16000
          });
          
          this.sourceNode = this.audioContext.createMediaStreamSource(this.microphoneStream);
          
          // Create analyser for mic level visualization
          this.analyser = this.audioContext.createAnalyser();
          this.analyser.fftSize = 256;
          this.analyser.smoothingTimeConstant = 0.8;
          
          // Create script processor for audio processing
          const bufferSize = 4096;
          this.processor = this.audioContext.createScriptProcessor(bufferSize, 1, 1);
          
          let audioChunkCount = 0;
          
          // Set up initial recognizer events
          this.setupRecognizerEvents();
          
          this.processor.onaudioprocess = (e) => {
            if (!this.isListening || !this.recognizer) return;
            
            audioChunkCount++;
            // Log every 200 chunks (~13 seconds)
            if (audioChunkCount % 200 === 0) {
              console.log('[Vosk] Processing audio chunks...', audioChunkCount);
            }
            
            // Vosk expects the AudioBuffer directly
            try {
              this.recognizer.acceptWaveform(e.inputBuffer);
            } catch (err) {
              console.error('[Vosk] Processing error:', err);
            }
          };
          
          // Connect audio pipeline: source -> analyser -> processor -> destination
          this.sourceNode.connect(this.analyser);
          this.analyser.connect(this.processor);
          this.processor.connect(this.audioContext.destination);
          
          console.log('[Vosk] ‚úì Audio pipeline ready with analyser');
        } catch (error) {
          console.error('[Vosk] Audio setup error:', error);
          throw error;
        }
      },

      start() {
        if (!this.isInitialized) {
          console.error('[Vosk] Not initialized');
          return;
        }

        // Check if already listening before starting
        if (this.isListening) {
          console.warn('[Vosk] Already listening, ensuring flags are synchronized');
          this.shouldProcessResults = true; // Re-enable processing just in case
          return;
        }

        this.isListening = true;
        this.shouldProcessResults = true; // Enable result processing
        console.log('[Vosk] Started listening (recording + processing)');
      },

      stopRecording() {
        // Stop RECORDING new audio, but keep processing enabled for final result
        this.isListening = false;
        console.log('[Vosk] Stopped recording (processing continues)');
        
        // Get final result
        if (this.recognizer) {
          try {
            console.log('[Vosk] Requesting final result...');
            this.recognizer.retrieveFinalResult();
            // The result will come via the 'result' event listener
          } catch (err) {
            console.error('[Vosk] Final result error:', err);
          }
        }
      },

      stop() {
        // Stop everything (recording + processing)
        this.isListening = false;
        this.shouldProcessResults = false;
        console.log('[Vosk] Stopped completely (recording + processing)');
      }
    };

    // ============================================
    // AUDIO VISUALIZER
    // ============================================
    const AudioVisualizer = {
      bars: [],
      isActive: false,
      animationFrame: null,

      init() {
        // Get A-Frame visualizer bars
        this.bars = [];
        for (let i = 0; i < 8; i++) {
          const bar = document.getElementById(`viz-bar-${i}`);
          if (bar) {
            this.bars.push(bar);
          }
        }
        console.log('[Visualizer] Initialized with', this.bars.length, 'bars');
      },

      start() {
        if (!VoskRecognizer.analyser) {
          console.error('[Visualizer] No analyser available');
          return;
        }

        this.isActive = true;
        // Show A-Frame mic visualizer entity
        const micEl = document.getElementById('ui-mic-viz');
        if (micEl) micEl.setAttribute('visible', true);
        console.log('[Visualizer] Started');
        this.draw();
      },

      stop() {
        this.isActive = false;
        // Hide A-Frame mic visualizer entity
        const micEl = document.getElementById('ui-mic-viz');
        if (micEl) micEl.setAttribute('visible', false);
        if (this.animationFrame) {
          cancelAnimationFrame(this.animationFrame);
        }
        console.log('[Visualizer] Stopped');
      },

      draw() {
        if (!this.isActive || !VoskRecognizer.analyser) return;

        this.animationFrame = requestAnimationFrame(() => this.draw());

        const frequencyArray = new Uint8Array(VoskRecognizer.analyser.frequencyBinCount);
        VoskRecognizer.analyser.getByteFrequencyData(frequencyArray);

        // Update each bar's height based on frequency data
        // Sample different frequency ranges for 8 bars
        const barCount = this.bars.length;
        const binSize = Math.floor(frequencyArray.length / barCount);
        
        for (let i = 0; i < barCount; i++) {
          // Average frequency for this bar
          const startBin = i * binSize;
          const endBin = startBin + binSize;
          let sum = 0;
          for (let j = startBin; j < endBin; j++) {
            sum += frequencyArray[j];
          }
          const average = sum / binSize;
          
          // Scale to height (0.05 to 0.3)
          const height = 0.05 + (average / 255) * 0.25;
          
          // Update bar height
          if (this.bars[i]) {
            this.bars[i].setAttribute('height', height.toFixed(3));
            // Adjust position to keep bottom aligned
            this.bars[i].setAttribute('position', `${i * 0.1} ${height / 2} 0`);
          }
        }
      }
    };

    // ============================================
    // DUTCH CONVERSATION APP
    // ============================================
    window.DutchApp = {
      // Helper functions for A-Frame UI
      showUIElement: function(elementId) {
        const el = document.getElementById(elementId);
        if (el) el.setAttribute('visible', true);
      },
      
      hideUIElement: function(elementId) {
        const el = document.getElementById(elementId);
        if (el) el.setAttribute('visible', false);
      },
      
      conversations: [
        {
          id: 'meetup-intro',
          name: 'Language Meetup - Getting Acquainted',
          exchanges: [
            // Exchange 0: Opening greeting
            {
              question: {
                dutch: "Hallo! Leuk je te ontmoeten. Hoe gaat het met je?",
                english: "Hello! Nice to meet you. How are you?",
                audio: "assets/audio/nl/meetup/ex0_hoe_gaat_het.mp3"
              },
              answers: [
                { dutch: "Goed, dank je! Ik ben een beetje zenuwachtig.", english: "Good, thank you! I'm a bit nervous.", branch: 1 },
                { dutch: "Heel goed! Ik vind het spannend om Nederlands te oefenen.", english: "Very good! I'm excited to practice Dutch.", branch: 2 },
                { dutch: "Prima! Ik ben hier voor het eerst.", english: "Great! This is my first time here.", branch: 3 }
              ]
            },
            
            // Branch 1: User is nervous
            {
              question: {
                dutch: "Maak je geen zorgen! Iedereen maakt fouten. Vertel eens, waar kom je vandaan?",
                english: "Don't worry! Everyone makes mistakes. Tell me, where are you from?",
                audio: "assets/audio/nl/meetup/ex1_waar_kom_je_vandaan.mp3"
              },
              answers: [
                { dutch: "Ik kom uit de Verenigde Staten, uit New York.", english: "I'm from the United States, from New York.", branch: 4 },
                { dutch: "Ik ben uit Australi√´, uit Sydney.", english: "I'm from Australia, from Sydney.", branch: 5 },
                { dutch: "Ik kom uit het Verenigd Koninkrijk, uit Londen.", english: "I'm from the United Kingdom, from London.", branch: 6 }
              ]
            },
            
            // Branch 2: User is excited
            {
              question: {
                dutch: "Wat leuk! Wat is je favoriete Nederlandse woord tot nu toe?",
                english: "How nice! What's your favorite Dutch word so far?",
                audio: "assets/audio/nl/meetup/ex2_favoriete_woord.mp3"
              },
              answers: [
                { dutch: "Ik vind 'gezellig' mooi. Het heeft geen echte vertaling.", english: "I like 'gezellig'. It has no real translation.", branch: 7 },
                { dutch: "'Alstublieft' klinkt grappig als ik het zeg!", english: "'Alstublieft' sounds funny when I say it!", branch: 8 },
                { dutch: "Ik weet het niet zeker. Ik leer nog steeds.", english: "I'm not sure. I'm still learning.", branch: 9 }
              ]
            },
            
            // Branch 3: First time at meetup
            {
              question: {
                dutch: "Welkom! Hoe heb je over deze meetup gehoord?",
                english: "Welcome! How did you hear about this meetup?",
                audio: "assets/audio/nl/meetup/ex3_hoe_gehoord.mp3"
              },
              answers: [
                { dutch: "Mijn vriend vertelde me erover. Hij komt hier vaak.", english: "My friend told me about it. He comes here often.", branch: 10 },
                { dutch: "Ik zag het op Facebook in een taalgroep.", english: "I saw it on Facebook in a language group.", branch: 11 },
                { dutch: "Ik zoekt online naar Nederlandse oefenmogelijkheden.", english: "I was searching online for Dutch practice opportunities.", branch: 12 }
              ]
            },
            
            // Branch 4: From New York
            {
              question: {
                dutch: "New York! Wat bracht je naar Nederland, of oefen je vanaf Amerika?",
                english: "New York! What brought you to the Netherlands, or are you practicing from America?",
                audio: "assets/audio/nl/meetup/ex4_naar_nederland.mp3"
              },
              answers: [
                { dutch: "Ik woon nu in Amsterdam. Ik werk hier als softwareontwikkelaar.", english: "I live in Amsterdam now. I work here as a software developer.", branch: 13 },
                { dutch: "Ik plan volgend jaar te verhuizen voor studie.", english: "I'm planning to move next year for studies.", branch: 14 },
                { dutch: "Ik oefen thuis. Mijn partner is Nederlands.", english: "I'm practicing from home. My partner is Dutch.", branch: 15 }
              ]
            },
            
            // Branch 5: From Sydney
            {
              question: {
                dutch: "Australi√´! Dat is een lange reis. Wat vind je het moeilijkste aan het Nederlands?",
                english: "Australia! That's a long journey. What do you find most difficult about Dutch?",
                audio: "assets/audio/nl/meetup/ex5_moeilijkste.mp3"
              },
              answers: [
                { dutch: "De uitspraak! Vooral de 'g' en 'sch' klanken.", english: "The pronunciation! Especially the 'g' and 'sch' sounds.", branch: 16 },
                { dutch: "De woordvolgorde in zinnen verwaart me soms.", english: "The word order in sentences confuses me sometimes.", branch: 17 },
                { dutch: "De lidwoorden 'de' en 'het'. Hoe weet je welke te gebruiken?", english: "The articles 'de' and 'het'. How do you know which to use?", branch: 18 }
              ]
            },
            
            // Branch 6: From London
            {
              question: {
                dutch: "Ah, het Verenigd Koninkrijk! Spreek je ook andere talen?",
                english: "Ah, the United Kingdom! Do you speak other languages too?",
                audio: "assets/audio/nl/meetup/ex6_andere_talen.mp3"
              },
              answers: [
                { dutch: "Ja, ik spreek vloeiend Frans. Ik studeerde het op school.", english: "Yes, I speak French fluently. I studied it at school.", branch: 19 },
                { dutch: "Een beetje Spaans, maar Nederlands is mijn derde poging!", english: "A bit of Spanish, but Dutch is my third attempt!", branch: 20 },
                { dutch: "Nee, alleen Engels tot nu toe. Nederlands is mijn eerste!", english: "No, just English so far. Dutch is my first!", branch: 21 }
              ]
            },
            
            // Branch 7: Likes "gezellig"
            {
              question: {
                dutch: "Precies! 'Gezellig' is typisch Nederlands. Hoe lang studeer je al?",
                english: "Exactly! 'Gezellig' is typically Dutch. How long have you been studying?",
                audio: "assets/audio/nl/meetup/ex7_hoe_lang.mp3"
              },
              answers: [
                { dutch: "Ongeveer zes maanden intensief. Ik gebruik Duolingo dagelijks.", english: "About six months intensively. I use Duolingo daily.", branch: 22 },
                { dutch: "Al twee jaar, maar pas recent met spreken begonnen.", english: "Two years already, but only recently started speaking.", branch: 23 },
                { dutch: "Drie maanden. Ik neem ook priv√©lessen.", english: "Three months. I'm also taking private lessons.", branch: 24 }
              ]
            },
            
            // Branch 8: Likes "alstublieft"
            {
              question: {
                dutch: "Haha, ja! Het is een mondvol. Gebruik je meestal 'alstublieft' of 'alsjeblieft'?",
                english: "Haha, yes! It's a mouthful. Do you usually use 'alstublieft' or 'alsjeblieft'?",
                audio: "assets/audio/nl/meetup/ex8_welke_versie.mp3"
              },
              answers: [
                { dutch: "Ik gebruik 'alsjeblieft' met vrienden, informeel.", english: "I use 'alsjeblieft' with friends, informally.", branch: 25 },
                { dutch: "Meestal 'alstublieft'. Ik wil beleefd zijn.", english: "Mostly 'alstublieft'. I want to be polite.", branch: 26 },
                { dutch: "Ik weet het verschil eigenlijk niet goed!", english: "I don't actually know the difference well!", branch: 27 }
              ]
            },
            
            // Branch 9: Not sure about favorite word
            {
              question: {
                dutch: "Dat is ok√©! Welk onderwerp vind je het leukst om over te praten?",
                english: "That's okay! What topic do you enjoy talking about most?",
                audio: "assets/audio/nl/meetup/ex9_onderwerp.mp3"
              },
              answers: [
                { dutch: "Ik praat graag over reizen en cultuur.", english: "I like to talk about travel and culture.", branch: 28 },
                { dutch: "Technologie en innovatie interesseren me het meest.", english: "Technology and innovation interest me most.", branch: 29 },
                { dutch: "Eten! Ik wil graag over Nederlandse gerechten leren.", english: "Food! I want to learn about Dutch dishes.", branch: 30 }
              ]
            },
            
            // Branch 10: Friend told about meetup
            {
              question: {
                dutch: "Wat aardig van je vriend! Is hij of zij ook hier vanavond?",
                english: "How nice of your friend! Is he or she also here tonight?",
                audio: "assets/audio/nl/meetup/ex10_vriend_hier.mp3"
              },
              answers: [
                { dutch: "Ja, hij komt later. Hij werkt tot acht uur.", english: "Yes, he's coming later. He works until eight o'clock.", branch: 31 },
                { dutch: "Nee, zij kon vanavond niet komen. Ze studeert voor examens.", english: "No, she couldn't come tonight. She's studying for exams.", branch: 32 },
                { dutch: "Eigenlijk weet ik het niet zeker. We spraken snel.", english: "Actually, I'm not sure. We spoke quickly.", branch: 33 }
              ]
            },
            
            // Branch 11: Found on Facebook
            {
              question: {
                dutch: "Social media is perfect voor taalgroepen! Volg je Nederlandse accounts?",
                english: "Social media is perfect for language groups! Do you follow Dutch accounts?",
                audio: "assets/audio/nl/meetup/ex11_nederlandse_accounts.mp3"
              },
              answers: [
                { dutch: "Ja! Ik volg Nederlandse nieuwskanalen en podcasts.", english: "Yes! I follow Dutch news channels and podcasts.", branch: 34 },
                { dutch: "Een paar, vooral voor leren en oefening.", english: "A few, mainly for learning and practice.", branch: 35 },
                { dutch: "Nog niet. Heb je aanbevelingen?", english: "Not yet. Do you have recommendations?", branch: 36 }
              ]
            },
            
            // Branch 12: Searched online
            {
              question: {
                dutch: "Goed initiatief! Wat is je leerdoel voor dit jaar?",
                english: "Good initiative! What's your learning goal for this year?",
                audio: "assets/audio/nl/meetup/ex12_leerdoel.mp3"
              },
              answers: [
                { dutch: "Ik wil conversaties kunnen voeren zonder Engels.", english: "I want to be able to have conversations without English.", branch: 37 },
                { dutch: "Het NT2 examen halen voor werk of studie.", english: "Pass the NT2 exam for work or study.", branch: 38 },
                { dutch: "Gewoon comfortabel voelen bij dagelijkse situaties.", english: "Just feel comfortable in daily situations.", branch: 39 }
              ]
            },
            
            // Continuation branches (13-39) - These create deeper conversations
            
            // Branch 13: Works in Amsterdam
            {
              question: {
                dutch: "Geweldig! Spreekt iedereen Engels op je werk, of moet je Nederlands gebruiken?",
                english: "Great! Does everyone speak English at your work, or do you need to use Dutch?",
                audio: "assets/audio/nl/meetup/ex13_werk_taal.mp3"
              },
              answers: [
                { dutch: "Voornamelijk Engels, maar vergaderingen zijn soms in het Nederlands.", english: "Mainly English, but meetings are sometimes in Dutch.", branch: 40 },
                { dutch: "Gemengd. Ik probeer meer Nederlands te spreken elke week.", english: "Mixed. I try to speak more Dutch each week.", branch: 40 },
                { dutch: "Meestal Nederlands nu. Het verbetert snel!", english: "Mostly Dutch now. It's improving fast!", branch: 40 }
              ]
            },
            
            // Branch 14: Planning to move for studies
            {
              question: {
                dutch: "Spannend! Welke universiteit? Wat ga je studeren?",
                english: "Exciting! Which university? What will you study?",
                audio: "assets/audio/nl/meetup/ex14_studie.mp3"
              },
              answers: [
                { dutch: "De Universiteit van Amsterdam, internationale betrekkingen.", english: "University of Amsterdam, international relations.", branch: 40 },
                { dutch: "TU Delft voor engineering. Het programma is wereldberoemd.", english: "TU Delft for engineering. The program is world-renowned.", branch: 40 },
                { dutch: "Erasmus Universiteit Rotterdam, bedrijfskunde.", english: "Erasmus University Rotterdam, business administration.", branch: 40 }
              ]
            },
            
            // Branch 15: Partner is Dutch
            {
              question: {
                dutch: "Wat romantisch! Praat je meestal Nederlands of Engels met je partner?",
                english: "How romantic! Do you usually speak Dutch or English with your partner?",
                audio: "assets/audio/nl/meetup/ex15_partner_taal.mp3"
              },
              answers: [
                { dutch: "We wisselen af. Hij/zij is geduldig met mijn fouten.", english: "We alternate. He/she is patient with my mistakes.", branch: 40 },
                { dutch: "Vooral Engels, maar ik wil meer Nederlands oefenen.", english: "Mainly English, but I want to practice more Dutch.", branch: 40 },
                { dutch: "Steeds meer Nederlands. Het helpt echt!", english: "More and more Dutch. It really helps!", branch: 40 }
              ]
            },
            
            // Branch 16: Pronunciation is difficult
            {
              question: {
                dutch: "Dat hoor ik vaak! Oefen je met tongbrekers zoals 'Scheveningen'?",
                english: "I hear that often! Do you practice with tongue twisters like 'Scheveningen'?",
                audio: "assets/audio/nl/meetup/ex16_tongbrekers.mp3"
              },
              answers: [
                { dutch: "Ja! Ik oefen dagelijks, maar het blijft lastig.", english: "Yes! I practice daily, but it remains difficult.", branch: 40 },
                { dutch: "Soms. YouTube video's helpen me veel.", english: "Sometimes. YouTube videos help me a lot.", branch: 40 },
                { dutch: "Nog niet geprobeerd. Dat klinkt moeilijk!", english: "Haven't tried yet. That sounds hard!", branch: 40 }
              ]
            },
            
            // Branch 17: Word order confuses
            {
              question: {
                dutch: "Het werkwoord aan het einde kan verwarrend zijn! Lees je Nederlandse boeken?",
                english: "The verb at the end can be confusing! Do you read Dutch books?",
                audio: "assets/audio/nl/meetup/ex17_boeken.mp3"
              },
              answers: [
                { dutch: "Ja, kinderboeken momenteel. Ze zijn makkelijker te begrijpen.", english: "Yes, children's books currently. They're easier to understand.", branch: 40 },
                { dutch: "Ik probeer het nieuws online te lezen dagelijks.", english: "I try to read the news online daily.", branch: 40 },
                { dutch: "Nog niet. Ik begin met korte artikelen eerst.", english: "Not yet. I'm starting with short articles first.", branch: 40 }
              ]
            },
            
            // Branch 18: Articles are difficult
            {
              question: {
                dutch: "Ah, de versus het! Er is geen perfecte regel. Leer je ze uit het hoofd?",
                english: "Ah, de versus het! There's no perfect rule. Do you learn them by heart?",
                audio: "assets/audio/nl/meetup/ex18_leren.mp3"
              },
              answers: [
                { dutch: "Ja, ik maak flashcards voor alle nieuwe woorden.", english: "Yes, I make flashcards for all new words.", branch: 40 },
                { dutch: "Ik probeer ze in context te onthouden uit zinnen.", english: "I try to remember them in context from sentences.", branch: 40 },
                { dutch: "Ik raad meestal. Ik heb het juist de helft van de tijd!", english: "I usually guess. I get it right half the time!", branch: 40 }
              ]
            },
            
            // Branch 19: Speaks French fluently
            {
              question: {
                dutch: "Fantastisch! Helpt Frans je met Nederlands leren, of juist niet?",
                english: "Fantastic! Does French help you with learning Dutch, or not really?",
                audio: "assets/audio/nl/meetup/ex19_frans_helpt.mp3"
              },
              answers: [
                { dutch: "Soms. Sommige woorden lijken op elkaar.", english: "Sometimes. Some words are similar.", branch: 40 },
                { dutch: "Niet echt. De grammatica is heel anders.", english: "Not really. The grammar is very different.", branch: 40 },
                { dutch: "Het helpt met leren algemeen. Ik ken de methode.", english: "It helps with learning in general. I know the method.", branch: 40 }
              ]
            },
            
            // Branch 20: Third language attempt
            {
              question: {
                dutch: "Derde keer is scheepsrecht! Waarom stopte je met Spaans?",
                english: "Third time's the charm! Why did you stop with Spanish?",
                audio: "assets/audio/nl/meetup/ex20_waarom_gestopt.mp3"
              },
              answers: [
                { dutch: "Gebrek aan tijd. Werk werd te druk toen.", english: "Lack of time. Work got too busy then.", branch: 40 },
                { dutch: "Ik had geen mensen om mee te oefenen.", english: "I had no people to practice with.", branch: 40 },
                { dutch: "Nederlands is relevanter voor mijn situatie nu.", english: "Dutch is more relevant to my situation now.", branch: 40 }
              ]
            },
            
            // Branch 21: Dutch is first language
            {
              question: {
                dutch: "Wat moedig! Waarom koos je Nederlands als je eerste vreemde taal?",
                english: "How brave! Why did you choose Dutch as your first foreign language?",
                audio: "assets/audio/nl/meetup/ex21_waarom_nederlands.mp3"
              },
              answers: [
                { dutch: "Ik hou van de cultuur en de kunst.", english: "I love the culture and the art.", branch: 40 },
                { dutch: "Ik plan in Amsterdam te wonen binnenkort.", english: "I plan to live in Amsterdam soon.", branch: 40 },
                { dutch: "Het leek uitdagend en anders!", english: "It seemed challenging and different!", branch: 40 }
              ]
            },
            
            // Branch 22: Six months with Duolingo
            {
              question: {
                dutch: "Goed bezig! Wat is je langste streak op Duolingo?",
                english: "Well done! What's your longest streak on Duolingo?",
                audio: "assets/audio/nl/meetup/ex22_streak.mp3"
              },
              answers: [
                { dutch: "123 dagen! Ik ben er trots op.", english: "123 days! I'm proud of it.", branch: 40 },
                { dutch: "Ongeveer 50. Ik verloor het eens op vakantie.", english: "About 50. I lost it once on vacation.", branch: 40 },
                { dutch: "Ik tel niet meer. Ik doe het gewoon dagelijks.", english: "I don't count anymore. I just do it daily.", branch: 40 }
              ]
            },
            
            // Branch 23: Two years, recently started speaking
            {
              question: {
                dutch: "Twee jaar! Vind je spreken moeilijker dan lezen en schrijven?",
                english: "Two years! Do you find speaking harder than reading and writing?",
                audio: "assets/audio/nl/meetup/ex23_spreken_moeilijker.mp3"
              },
              answers: [
                { dutch: "Ja, veel moeilijker. Ik moet snel denken.", english: "Yes, much harder. I have to think quickly.", branch: 40 },
                { dutch: "Het went langzaam. Praktijk maakt perfect.", english: "It's getting easier slowly. Practice makes perfect.", branch: 40 },
                { dutch: "Verstaan is het moeilijkst voor mij eigenlijk.", english: "Understanding is actually the hardest for me.", branch: 40 }
              ]
            },
            
            // Branch 24: Three months with private lessons
            {
              question: {
                dutch: "Priv√©lessen zijn effectief! Hoe vaak heb je les per week?",
                english: "Private lessons are effective! How often do you have lessons per week?",
                audio: "assets/audio/nl/meetup/ex24_hoe_vaak_les.mp3"
              },
              answers: [
                { dutch: "Twee keer per week, telkens een uur.", english: "Twice a week, one hour each time.", branch: 40 },
                { dutch: "E√©n keer, maar wel twee uur intensief.", english: "Once, but two hours intensively.", branch: 40 },
                { dutch: "Het varieert. Mijn leraar is flexibel.", english: "It varies. My teacher is flexible.", branch: 40 }
              ]
            },
            
            // Branches 25-39 continue similarly...
            // For brevity, I'll add the remaining branches to reach the final question
            
            { question: { dutch: "Dat is slim! Formeel en informeel zijn belangrijk in het Nederlands.", english: "That's smart! Formal and informal are important in Dutch.", audio: "assets/audio/nl/meetup/ex25_formeel.mp3" }, answers: [{ dutch: "Ja, precies! Het is als 'you' versus 'y'all'.", english: "Yes, exactly! It's like 'you' versus 'y'all'.", branch: 40 }, { dutch: "Wanneer gebruik je 'u' in plaats van 'je'?", english: "When do you use 'u' instead of 'je'?", branch: 40 }, { dutch: "Het is verwarrend, maar ik leer het.", english: "It's confusing, but I'm learning it.", branch: 40 }] },
            { question: { dutch: "Goed! Beleefdheid wordt gewaardeerd in Nederlandse cultuur.", english: "Good! Politeness is appreciated in Dutch culture.", audio: "assets/audio/nl/meetup/ex26_beleefdheid.mp3" }, answers: [{ dutch: "Dat is goed om te weten. Dank je!", english: "That's good to know. Thank you!", branch: 40 }, { dutch: "Zijn Nederlanders over het algemeen formeel?", english: "Are Dutch people generally formal?", branch: 40 }, { dutch: "Ik wil geen onbeleefd overkomen.", english: "I don't want to come across as rude.", branch: 40 }] },
            { question: { dutch: "'Alsjeblieft' is informeel, 'alstublieft' is formeel. Zoals 'jij' en 'u'!", english: "'Alsjeblieft' is informal, 'alstublieft' is formal. Like 'jij' and 'u'!", audio: "assets/audio/nl/meetup/ex27_uitleg.mp3" }, answers: [{ dutch: "Ah! Dat maakt nu veel meer zin.", english: "Ah! That makes much more sense now.", branch: 40 }, { dutch: "Dus met familie gebruik ik 'alsjeblieft'?", english: "So with family I use 'alsjeblieft'?", branch: 40 }, { dutch: "Bedankt voor de uitleg! Heel nuttig.", english: "Thanks for the explanation! Very useful.", branch: 40 }] },
            { question: { dutch: "Reizen is een geweldig onderwerp! Ben je al in Nederland geweest?", english: "Travel is a great topic! Have you been to the Netherlands?", audio: "assets/audio/nl/meetup/ex28_nederland_bezocht.mp3" }, answers: [{ dutch: "Ja, vorig jaar voor twee weken. Het was prachtig!", english: "Yes, last year for two weeks. It was beautiful!", branch: 40 }, { dutch: "Nog niet, maar ik plan volgend voorjaar te gaan.", english: "Not yet, but I'm planning to go next spring.", branch: 40 }, { dutch: "Alleen Amsterdam. Ik wil meer steden zien.", english: "Only Amsterdam. I want to see more cities.", branch: 40 }] },
            { question: { dutch: "Tech is populair hier! Ken je Nederlandse tech bedrijven zoals Booking.com?", english: "Tech is popular here! Do you know Dutch tech companies like Booking.com?", audio: "assets/audio/nl/meetup/ex29_tech_bedrijven.mp3" }, answers: [{ dutch: "Ja! En ook Adyen en Mollie voor betalingen.", english: "Yes! And also Adyen and Mollie for payments.", branch: 40 }, { dutch: "Een paar. Nederland is innovatief in tech.", english: "A few. The Netherlands is innovative in tech.", branch: 40 }, { dutch: "Ik wil meer leren over de tech scene hier.", english: "I want to learn more about the tech scene here.", branch: 40 }] },
            { question: { dutch: "Lekker! Ken je stroopwafels? En bitterballen?", english: "Yummy! Do you know stroopwafels? And bitterballen?", audio: "assets/audio/nl/meetup/ex30_eten.mp3" }, answers: [{ dutch: "Ja! Stroopwafels zijn verslavend lekker!", english: "Yes! Stroopwafels are addictively delicious!", branch: 40 }, { dutch: "Bitterballen heb ik geprobeerd. Zo goed met mosterd!", english: "I've tried bitterballen. So good with mustard!", branch: 40 }, { dutch: "Nog niet! Waar kan ik ze proberen?", english: "Not yet! Where can I try them?", branch: 40 }] },
            
            // Branches 31-39 (friend/meetup related)
            { question: { dutch: "Gezellig! Dan kunnen jullie straks samen oefenen.", english: "Nice! Then you can practice together later.", audio: "assets/audio/nl/meetup/ex31_samen.mp3" }, answers: [{ dutch: "Ja, hij spreekt al goed Nederlands.", english: "Yes, he already speaks Dutch well.", branch: 40 }, { dutch: "We helpen elkaar met moeilijke zinnen.", english: "We help each other with difficult sentences.", branch: 40 }, { dutch: "Ik hoop dat hij niet te laat komt!", english: "I hope he doesn't come too late!", branch: 40 }] },
            { question: { dutch: "Veel succes met haar examens! Studeert zij ook Nederlands?", english: "Good luck with her exams! Is she also studying Dutch?", audio: "assets/audio/nl/meetup/ex32_studie.mp3" }, answers: [{ dutch: "Nee, zij studeert medicijnen. Heel zwaar.", english: "No, she studies medicine. Very tough.", branch: 40 }, { dutch: "Ja! We oefenen soms samen.", english: "Yes! We practice together sometimes.", branch: 40 }, { dutch: "Ze spreekt al vloeiend. Ze is Nederlandse.", english: "She already speaks fluently. She's Dutch.", branch: 40 }] },
            { question: { dutch: "Geen probleem! Het belangrijkste is dat jij hier bent.", english: "No problem! The important thing is that you're here.", audio: "assets/audio/nl/meetup/ex33_jij_hier.mp3" }, answers: [{ dutch: "Ja, ik wilde niet meer uitstellen.", english: "Yes, I didn't want to postpone anymore.", branch: 40 }, { dutch: "Ik ben zenuwachtig maar ook opgewonden!", english: "I'm nervous but also excited!", branch: 40 }, { dutch: "Beter alleen beginnen dan nooit!", english: "Better to start alone than never!", branch: 40 }] },
            { question: { dutch: "Slim! Onderdompeling helpt enorm met leren.", english: "Smart! Immersion helps tremendously with learning.", audio: "assets/audio/nl/meetup/ex34_onderdompeling.mp3" }, answers: [{ dutch: "Absoluut! Ik luister ook naar NOS Journaal.", english: "Absolutely! I also listen to NOS Journaal.", branch: 40 }, { dutch: "En Nederlandse Netflix series met ondertiteling.", english: "And Dutch Netflix series with subtitles.", branch: 40 }, { dutch: "Elke dag een beetje helpt echt.", english: "A little bit every day really helps.", branch: 40 }] },
            { question: { dutch: "Natuurlijk! Probeer 'Easy Dutch' op YouTube. Erg nuttig!", english: "Of course! Try 'Easy Dutch' on YouTube. Very useful!", audio: "assets/audio/nl/meetup/ex35_aanbeveling.mp3" }, answers: [{ dutch: "Bedankt! Ik ga dat vanavond bekijken.", english: "Thanks! I'll check that out tonight.", branch: 40 }, { dutch: "Zijn er ook goede podcasts?", english: "Are there also good podcasts?", branch: 40 }, { dutch: "Perfect! Ik maak een lijst.", english: "Perfect! I'll make a list.", branch: 40 }] },
            { question: { dutch: "Ja! Volg ook @learndutch en @dutchgrammar op Instagram.", english: "Yes! Also follow @learndutch and @dutchgrammar on Instagram.", audio: "assets/audio/nl/meetup/ex36_instagram.mp3" }, answers: [{ dutch: "Geweldig, dank je wel voor de tips!", english: "Great, thank you for the tips!", branch: 40 }, { dutch: "Ik ga ze nu meteen volgen.", english: "I'm going to follow them right now.", branch: 40 }, { dutch: "Social media leren werkt echt goed.", english: "Social media learning really works well.", branch: 40 }] },
            { question: { dutch: "Dat is een uitstekend doel! Hoeveel uur per week studeer je?", english: "That's an excellent goal! How many hours per week do you study?", audio: "assets/audio/nl/meetup/ex37_uren.mp3" }, answers: [{ dutch: "Ongeveer 10 uur, inclusief deze meetups.", english: "About 10 hours, including these meetups.", branch: 40 }, { dutch: "Zoveel als mogelijk. Minstens 5 uur.", english: "As much as possible. At least 5 hours.", branch: 40 }, { dutch: "Het varieert, maar ik probeer consistent te zijn.", english: "It varies, but I try to be consistent.", branch: 40 }] },
            { question: { dutch: "Het NT2 examen! Dat is serieus. Welk niveau ga je proberen?", english: "The NT2 exam! That's serious. Which level are you going to attempt?", audio: "assets/audio/nl/meetup/ex38_niveau.mp3" }, answers: [{ dutch: "NT2 Programma I. Het basisniveau voor werk.", english: "NT2 Program I. The basic level for work.", branch: 40 }, { dutch: "NT2 Programma II voor universitaire studie.", english: "NT2 Program II for university study.", branch: 40 }, { dutch: "Ik weet het nog niet zeker. Eerst oefenen!", english: "I'm not sure yet. First practice!", branch: 40 }] },
            { question: { dutch: "Dat is heel praktisch! Dagelijkse conversaties zijn het belangrijkst.", english: "That's very practical! Daily conversations are most important.", audio: "assets/audio/nl/meetup/ex39_praktisch.mp3" }, answers: [{ dutch: "Precies. Boodschappen doen, bestellen in restaurants...", english: "Exactly. Grocery shopping, ordering in restaurants...", branch: 40 }, { dutch: "En praten met buren en collega's.", english: "And talking with neighbors and colleagues.", branch: 40 }, { dutch: "Klein stapjes, maar vooruitgang!", english: "Small steps, but progress!", branch: 40 }] },
            
            // Branch 40: Final closing question (everyone converges here)
            {
              question: {
                dutch: "Wat geweldig om je verhaal te horen! Zullen we volgende week weer afspreken om verder te oefenen?",
                english: "How wonderful to hear your story! Shall we meet again next week to practice more?",
                audio: "assets/audio/nl/meetup/ex40_volgende_week.mp3"
              },
              answers: [
                { dutch: "Ja, graag! Zelfde tijd, zelfde plaats?", english: "Yes, please! Same time, same place?" },
                { dutch: "Absoluut! Ik kijk er naar uit.", english: "Absolutely! I'm looking forward to it." },
                { dutch: "Heel graag! Dit was echt nuttig.", english: "Very much! This was really useful." }
              ]
            }
          ]
        }
      ],

      currentConversation: null,
      currentExchangeIndex: 0,
      currentAudio: null,
      accuracyScores: [],
      isProcessing: false,
      awaitingRetry: false,

      async init() {
        console.log('[DutchApp] Initializing...');

        // Initialize Vosk
        try {
          document.getElementById('loading-text').textContent = 'Loading Dutch model...';
          await VoskRecognizer.init(
            this.onSpeechResult.bind(this),
            this.onSpeechPartial.bind(this)
          );
          console.log('[DutchApp] ‚úì Vosk initialized');
        } catch (error) {
          console.error('[DutchApp] Vosk initialization failed:', error);
          
          // Show user-friendly error message
          const errorMessage = error.userMessage || '‚ùå Failed to initialize. Please refresh and try again.';
          document.getElementById('loading-text').textContent = 'Initialization Failed';
          document.getElementById('loading-error').textContent = errorMessage;
          document.getElementById('loading-error').style.display = 'block';
          document.getElementById('retry-btn').style.display = 'block';
          document.querySelector('.spinner').style.display = 'none';
          
          // Show microphone help for permission errors
          if (error.name === 'NotAllowedError') {
            document.getElementById('mic-help').style.display = 'block';
          }
          
          return;
        }

        // Initialize visualizer
        AudioVisualizer.init();

        // Setup controller events
        this.setupControllers();

        // Hide loading screen
        document.getElementById('loading-screen').classList.add('hidden');

        // Show start button (A-Frame entity, not CSS3D)
        this.showUIElement('ui-start');
        this.showUIElement('ui-instructions');

        // Setup click handler for start button
        const startBox = document.querySelector('#ui-start .clickable');
        if (startBox) {
          startBox.addEventListener('click', () => {
            console.log('[DutchApp] Start button clicked');
            this.startExperience();
          });
        }

        console.log('[DutchApp] ‚úì Initialization complete - waiting for user to start');
      },

      startExperience() {
        console.log('[DutchApp] User clicked Start - beginning conversation');
        
        // Hide start button
        this.hideUIElement('ui-start');
        
        // Start conversation
        this.startConversation('meetup-intro');
      },

      retryInit() {
        // Reset loading screen
        document.getElementById('loading-text').textContent = 'Loading Dutch Language Model...';
        document.getElementById('loading-error').style.display = 'none';
        document.getElementById('mic-help').style.display = 'none';
        document.getElementById('retry-btn').style.display = 'none';
        document.querySelector('.spinner').style.display = 'block';
        
        // Try again
        setTimeout(() => {
          this.init();
        }, 100);
      },

      setupControllers() {
        const scene = document.querySelector('a-scene');
        
        // Wait for scene to load
        if (scene.hasLoaded) {
          this.attachControllerListeners();
        } else {
          scene.addEventListener('loaded', () => this.attachControllerListeners());
        }
      },

      attachControllerListeners() {
        const rightHand = document.getElementById('right-hand');
        
        if (!rightHand) {
          console.warn('[DutchApp] Right hand controller not found');
          return;
        }

        // Listen for trigger press (push-to-talk)
        rightHand.addEventListener('triggerdown', () => {
          console.log('[DutchApp] Trigger pressed - starting mic');
          this.startListening();
        });

        rightHand.addEventListener('triggerup', () => {
          console.log('[DutchApp] Trigger released - stopping mic');
          this.stopListening();
        });

        console.log('[DutchApp] ‚úì Controller listeners attached');
      },

      startConversation(conversationId) {
        this.currentConversation = this.conversations.find(c => c.id === conversationId);
        this.currentExchangeIndex = 0;
        this.accuracyScores = [];
        
        console.log('[DutchApp] Starting conversation:', this.currentConversation.name);
        this.showNextExchange();
      },

      showNextExchange() {
        if (this.currentExchangeIndex >= this.currentConversation.exchanges.length) {
          this.showFinalScore();
          return;
        }

        const exchange = this.currentConversation.exchanges[this.currentExchangeIndex];
        
        // Show question using A-Frame text
        const questionNL = document.getElementById('question-text-nl');
        const questionEN = document.getElementById('question-text-en');
        if (questionNL) questionNL.setAttribute('value', exchange.question.dutch);
        if (questionEN) {
          questionEN.setAttribute('value', `(${exchange.question.english})`);
          questionEN.setAttribute('visible', false);
        }
        
        // Add hover listener to question panel to show/hide translation
        const questionPanel = document.getElementById('ui-question');
        if (questionPanel) {
          questionPanel.addEventListener('raycaster-intersected', () => {
            if (questionEN) questionEN.setAttribute('visible', true);
          });
          questionPanel.addEventListener('raycaster-intersected-cleared', () => {
            if (questionEN) questionEN.setAttribute('visible', false);
          });
        }
        
        this.showUIElement('ui-question');

        // Show answer choices using A-Frame text
        for (let i = 0; i < 3; i++) {
          const answerText = document.getElementById(`answer${i+1}-text`);
          const answerEN = document.getElementById(`answer${i+1}-en`);
          const answerPanel = document.getElementById(`ui-answer${i+1}`);
          
          if (answerText && exchange.answers[i]) {
            answerText.setAttribute('value', exchange.answers[i].dutch);
          }
          if (answerEN && exchange.answers[i]) {
            answerEN.setAttribute('value', `(${exchange.answers[i].english})`);
            answerEN.setAttribute('visible', false);
          }
          
          // Add hover listener to answer panel
          if (answerPanel) {
            answerPanel.addEventListener('raycaster-intersected', () => {
              if (answerEN) answerEN.setAttribute('visible', true);
            });
            answerPanel.addEventListener('raycaster-intersected-cleared', () => {
              if (answerEN) answerEN.setAttribute('visible', false);
            });
          }
          
          this.showUIElement(`ui-answer${i+1}`);
        }

        // Play question audio
        this.playQuestionAudio(exchange.question.audio);

        // Reset state
        this.isProcessing = false;
        this.awaitingRetry = false;
      },

      renderAnswerChoices(answers) {
        const container = document.getElementById('answer-choices');
        container.innerHTML = '';

        answers.forEach((answer, index) => {
          const card = document.createElement('div');
          card.className = 'answer-card clickable';
          card.innerHTML = `
            <div class="answer-dutch">${answer.dutch}</div>
            <div class="answer-english">${answer.english}</div>
          `;
          container.appendChild(card);
        });
      },

      playQuestionAudio(audioUrl) {
        if (this.currentAudio) {
          this.currentAudio.pause();
        }

        this.currentAudio = new Audio(audioUrl);
        this.currentAudio.play().catch(e => {
          console.warn('[DutchApp] Audio playback failed:', e);
        });
      },

      repeatQuestion() {
        const exchange = this.currentConversation.exchanges[this.currentExchangeIndex];
        this.playQuestionAudio(exchange.question.audio);
      },

      startListening() {
        if (this.isProcessing || !VoskRecognizer.isInitialized) return;

        console.log('[DutchApp] Starting listening...');
        VoskRecognizer.start(); // This sets shouldProcessResults = true
        AudioVisualizer.start();
      },

      stopListening() {
        if (!VoskRecognizer.isListening) return;

        console.log('[DutchApp] Stopping recording (waiting for result)...');
        VoskRecognizer.stopRecording(); // Stop recording but keep processing
        AudioVisualizer.stop();
        
        // Show "Processing..." indicator
        const micEl = document.getElementById('ui-mic-viz');
        if (micEl) {
          micEl.setAttribute('visible', true);
          const micText = micEl.querySelector('a-text');
          if (micText) micText.setAttribute('value', '‚è≥ Processing...');
        }
        
        // Disable processing after 2 seconds if no result came through
        // (Handles edge case where final result never arrives)
        setTimeout(() => {
          if (VoskRecognizer.shouldProcessResults && !VoskRecognizer.isListening) {
            VoskRecognizer.shouldProcessResults = false;
            console.log('[DutchApp] Processing timeout - disabled');
            if (micEl) micEl.setAttribute('visible', false);
          }
        }, 2000);
      },

      onSpeechPartial(text) {
        console.log('[DutchApp] Partial:', text);
      },

      onSpeechResult(text) {
        console.log('[DutchApp] Final result:', text);
        
        // Hide processing indicator
        const micEl = document.getElementById('ui-mic-viz');
        if (micEl) micEl.setAttribute('visible', false);
        
        // DON'T disable processing here - user might still be holding trigger!
        // It will be disabled when they start the next recording
        
        if (!text || text.trim() === '') {
          console.warn('[DutchApp] Empty result, ignoring');
          this.isProcessing = false;
          return;
        }

        this.evaluateAnswer(text);
      },

      evaluateAnswer(spokenText) {
        this.isProcessing = true;
        const exchange = this.currentConversation.exchanges[this.currentExchangeIndex];
        
        // Calculate similarity to each answer (include branch info)
        const similarities = exchange.answers.map((answer, index) => ({
          answer: answer.dutch,
          score: calculateSimilarity(spokenText, answer.dutch),
          branch: answer.branch !== undefined ? answer.branch : null,
          answerIndex: index
        }));

        // Find best match
        const bestMatch = similarities.reduce((best, current) => 
          current.score > best.score ? current : best
        );

        console.log('[DutchApp] Best match:', bestMatch);

        // Show result in VR UI
        const recognitionText = document.getElementById('recognition-text');
        const accuracyText = document.getElementById('accuracy-text');
        
        if (recognitionText) {
          recognitionText.setAttribute('value', `You said: "${spokenText}"`);
        }
        if (accuracyText) {
          const color = bestMatch.score >= 60 ? '#4CAF50' : '#FF5252';
          accuracyText.setAttribute('value', `Accuracy: ${bestMatch.score}%`);
          accuracyText.setAttribute('color', color);
        }
        
        this.showUIElement('ui-recognition-result');
        
        // Hide result after 3 seconds
        setTimeout(() => {
          this.hideUIElement('ui-recognition-result');
        }, 3000);

        // Determine if answer is acceptable
        const threshold = this.awaitingRetry ? 0 : 60; // Lower threshold on retry
        
        if (bestMatch.score >= threshold) {
          // Accept answer and move on
          this.accuracyScores.push(bestMatch.score);
          
          // Check if this answer leads to a branch
          if (bestMatch.branch !== null) {
            // Branch to specific exchange
            this.currentExchangeIndex = bestMatch.branch;
            console.log(`[DutchApp] Branching to exchange ${bestMatch.branch}`);
          } else {
            // No branch - move to next exchange sequentially
            this.currentExchangeIndex++;
          }
          
          this.awaitingRetry = false;
          setTimeout(() => {
            this.showNextExchange();
          }, 3000);
        } else if (!this.awaitingRetry) {
          // First time failing - ask for retry
          this.awaitingRetry = true;
          this.isProcessing = false;
          setTimeout(() => {
            if (recognitionText) recognitionText.setAttribute('value', 'Try again!');
            if (accuracyText) {
              accuracyText.setAttribute('value', 'Hold trigger and speak clearly');
              accuracyText.setAttribute('color', '#FFD700');
            }
            this.showUIElement('ui-recognition-result');
            setTimeout(() => {
              this.hideUIElement('ui-recognition-result');
            }, 2000);
          }, 3000);
        } else {
          // Second attempt - accept and move on anyway
          this.accuracyScores.push(bestMatch.score);
          
          // Check if this answer leads to a branch
          if (bestMatch.branch !== null) {
            this.currentExchangeIndex = bestMatch.branch;
            console.log(`[DutchApp] Branching to exchange ${bestMatch.branch} (retry)`);
          } else {
            this.currentExchangeIndex++;
          }
          
          this.awaitingRetry = false;
          setTimeout(() => {
            this.showNextExchange();
          }, 3000);
        }
      },

      showFinalScore() {
        // Hide question and answers
        this.hideUIElement('ui-question');
        this.hideUIElement('ui-answer1');
        this.hideUIElement('ui-answer2');
        this.hideUIElement('ui-answer3');

        // Calculate average accuracy
        const totalAccuracy = Math.round(
          this.accuracyScores.reduce((sum, score) => sum + score, 0) / this.accuracyScores.length
        );

        // Check and update best score
        const conversationId = this.currentConversation.id;
        const bestScore = localStorage.getItem(`best-${conversationId}`);
        const isNewBest = !bestScore || totalAccuracy > parseInt(bestScore);
        
        if (isNewBest) {
          localStorage.setItem(`best-${conversationId}`, totalAccuracy);
        }

        // Show result in VR UI
        const finalAccuracyText = document.getElementById('final-accuracy-text');
        const bestScoreText = document.getElementById('best-score-text');
        
        if (finalAccuracyText) {
          finalAccuracyText.setAttribute('value', `Overall Accuracy: ${totalAccuracy}%`);
        }
        if (bestScoreText) {
          if (isNewBest) {
            bestScoreText.setAttribute('value', 'üéâ New Personal Best!');
            bestScoreText.setAttribute('color', '#FFD700');
          } else {
            bestScoreText.setAttribute('value', `Personal Best: ${bestScore}%`);
            bestScoreText.setAttribute('color', '#FFD700');
          }
        }
        
        this.showUIElement('ui-final-score');
        
        // Setup restart button
        const restartButton = document.getElementById('restart-button');
        if (restartButton) {
          restartButton.addEventListener('click', () => {
            console.log('[DutchApp] Restart button clicked');
            this.restart();
          });
        }

        console.log('[DutchApp] Conversation complete. Accuracy:', totalAccuracy);
      },

      restart() {
        this.hideUIElement('ui-final-score');
        this.startConversation(this.currentConversation.id);
      }
    };

    // ============================================
    // INITIALIZE ON PAGE LOAD
    // ============================================
    window.addEventListener('load', () => {
      DutchApp.init();
    });
  </script>
</body>
</html>
