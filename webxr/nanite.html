<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Nanite-Style LOD Demo for Quest 3</title>
    <meta name="description" content="Nanite-inspired LOD system with automatic billboards">
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/supermedium/superframe@master/components/fps-counter/dist/aframe-fps-counter-component.min.js"></script>
</head>
<body>
    <script>
      // Nanite-Style LOD System for A-Frame
      // Simplified implementation demonstrating the concepts
      
      AFRAME.registerComponent('nanite-lod', {
        schema: {
          highDetail: { type: 'string' },        // High-poly model
          mediumDetail: { type: 'string' },      // Medium-poly model  
          lowDetail: { type: 'string' },         // Low-poly model
          billboardTexture: { type: 'string' },  // Billboard texture
          nearDistance: { default: 20 },         // Switch to medium detail
          mediumDistance: { default: 50 },       // Switch to low detail
          farDistance: { default: 100 },         // Switch to billboard
          billboardSize: { default: 5 },         // Billboard plane size
          updateFrequency: { default: 5 }        // Update every N frames
        },
        
        init: function() {
          this.frameCounter = 0;
          this.currentLOD = null;
          
          console.log(`üîß Initializing nanite-lod for: ${this.el.id || 'unnamed'}`);
          
          // Create LOD entities
          this.createLODEntities();
          
          // Find camera with retries
          this.findCamera();
        },
        
        findCamera: function() {
          // Try multiple ways to find the camera
          this.camera = document.querySelector('[camera]') || 
                       document.querySelector('a-camera') ||
                       document.querySelector('#rig a-camera') ||
                       document.querySelector('#rig [camera]');
          
          if (!this.camera) {
            console.warn(`‚ö†Ô∏è Camera not found for ${this.el.id}, retrying...`);
            setTimeout(() => this.findCamera(), 500);
            return;
          }
          
          console.log(`üì∑ Camera found for ${this.el.id}:`, this.camera.tagName);
          
          // Initial LOD selection
          setTimeout(() => {
            this.updateLOD();
            console.log(`‚úÖ Initial LOD set for: ${this.el.id || 'unnamed'}`);
          }, 100);
        },
        
        createLODEntities: function() {
          // High detail model
          this.highDetailEl = document.createElement('a-entity');
          if (this.data.highDetail) {
            this.highDetailEl.setAttribute('gltf-model', this.data.highDetail);
          } else {
            // Fallback: detailed geometry
            this.highDetailEl.setAttribute('geometry', 'primitive: icosahedron; radius: 2; detail: 3');
            this.highDetailEl.setAttribute('material', 'color: #ff6b6b; metalness: 0.8; roughness: 0.2; emissive: #331111; emissiveIntensity: 0.3');
          }
          this.highDetailEl.setAttribute('visible', false);
          this.el.appendChild(this.highDetailEl);
          
          // Medium detail model
          this.mediumDetailEl = document.createElement('a-entity');
          if (this.data.mediumDetail) {
            this.mediumDetailEl.setAttribute('gltf-model', this.data.mediumDetail);
          } else {
            // Fallback: medium geometry
            this.mediumDetailEl.setAttribute('geometry', 'primitive: icosahedron; radius: 2; detail: 2');
            this.mediumDetailEl.setAttribute('material', 'color: #4ecdc4; metalness: 0.6; roughness: 0.3; emissive: #113333; emissiveIntensity: 0.3');
          }
          this.mediumDetailEl.setAttribute('visible', false);
          this.el.appendChild(this.mediumDetailEl);
          
          // Low detail model
          this.lowDetailEl = document.createElement('a-entity');
          if (this.data.lowDetail) {
            this.lowDetailEl.setAttribute('gltf-model', this.data.lowDetail);
          } else {
            // Fallback: simple geometry
            this.lowDetailEl.setAttribute('geometry', 'primitive: icosahedron; radius: 2; detail: 1');
            this.lowDetailEl.setAttribute('material', 'color: #45b7d1; metalness: 0.4; roughness: 0.4; emissive: #111133; emissiveIntensity: 0.3');
          }
          this.lowDetailEl.setAttribute('visible', false);
          this.el.appendChild(this.lowDetailEl);
          
          // Billboard impostor
          this.billboardEl = document.createElement('a-entity');
          this.billboardEl.setAttribute('billboard-impostor', {
            texture: this.data.billboardTexture,
            size: this.data.billboardSize
          });
          this.billboardEl.setAttribute('visible', false);
          this.el.appendChild(this.billboardEl);
        },
        
        tick: function() {
          // Update LOD every N frames for performance
          this.frameCounter++;
          if (this.frameCounter % this.data.updateFrequency === 0) {
            this.updateLOD();
          }
        },
        
        updateLOD: function() {
          if (!this.camera) {
            console.warn(`‚ùå No camera found for LOD update: ${this.el.id}`);
            return;
          }
          
          const distance = this.el.object3D.position.distanceTo(
            this.camera.object3D.position
          );
          
          let newLOD;
          if (distance < this.data.nearDistance) {
            newLOD = 'high';
          } else if (distance < this.data.mediumDistance) {
            newLOD = 'medium';
          } else if (distance < this.data.farDistance) {
            newLOD = 'low';
          } else {
            newLOD = 'billboard';
          }
          
          // Debug: Log every update for first few seconds
          if (performance.now() < 10000) {
            console.log(`üîç ${this.el.id}: distance=${distance.toFixed(1)}, LOD=${newLOD}, thresholds=[${this.data.nearDistance}, ${this.data.mediumDistance}, ${this.data.farDistance}]`);
          }
          
          // Only update if LOD changed
          if (newLOD !== this.currentLOD) {
            this.switchToLOD(newLOD);
            this.currentLOD = newLOD;
            
            // Debug logging
            console.log(`LOD Switch: ${this.el.id || 'unnamed'} -> ${newLOD} (distance: ${distance.toFixed(1)})`);
          }
        },
        
        switchToLOD: function(lodLevel) {
          // Hide all LODs
          this.highDetailEl.setAttribute('visible', false);
          this.mediumDetailEl.setAttribute('visible', false);
          this.lowDetailEl.setAttribute('visible', false);
          this.billboardEl.setAttribute('visible', false);
          
          // Show selected LOD
          switch(lodLevel) {
            case 'high':
              this.highDetailEl.setAttribute('visible', true);
              console.log(`üëÅÔ∏è Showing HIGH detail for ${this.el.id}`);
              break;
            case 'medium':
              this.mediumDetailEl.setAttribute('visible', true);
              console.log(`üëÅÔ∏è Showing MEDIUM detail for ${this.el.id}`);
              break;
            case 'low':
              this.lowDetailEl.setAttribute('visible', true);
              console.log(`üëÅÔ∏è Showing LOW detail for ${this.el.id}`);
              break;
            case 'billboard':
              this.billboardEl.setAttribute('visible', true);
              console.log(`üëÅÔ∏è Showing BILLBOARD for ${this.el.id}`);
              break;
          }
        }
      });
      
      // Billboard Impostor Component
      AFRAME.registerComponent('billboard-impostor', {
        schema: {
          texture: { type: 'string' },
          size: { default: 5 }
        },
        
        init: function() {
          this.camera = document.querySelector('[camera]');
          
          // Create billboard plane
          this.el.setAttribute('geometry', {
            primitive: 'plane',
            width: this.data.size,
            height: this.data.size
          });
          
          // Set material
          if (this.data.texture) {
            this.el.setAttribute('material', {
              src: this.data.texture,
              transparent: true,
              alphaTest: 0.1,
              side: 'double'
            });
          } else {
            // Fallback: simple colored plane with fake lighting
            this.el.setAttribute('material', {
              color: '#96ceb4',
              transparent: true,
              opacity: 0.9,
              side: 'double',
              shader: 'flat'
            });
          }
        },
        
        tick: function() {
          // Make billboard face camera
          if (this.camera) {
            this.el.object3D.lookAt(this.camera.object3D.position);
          }
        }
      });
      
      // Performance Monitor Component
      AFRAME.registerComponent('performance-monitor', {
        init: function() {
          this.lastTime = performance.now();
          this.frameCount = 0;
          this.fpsDisplay = document.querySelector('#fps-display');
        },
        
        tick: function() {
          this.frameCount++;
          const currentTime = performance.now();
          
          if (currentTime - this.lastTime >= 1000) {
            const fps = Math.round(this.frameCount * 1000 / (currentTime - this.lastTime));
            
            if (this.fpsDisplay) {
              this.fpsDisplay.setAttribute('text', 'value', `FPS: ${fps}`);
              
              // Color code FPS
              if (fps >= 72) {
                this.fpsDisplay.setAttribute('text', 'color', '#00ff00');
              } else if (fps >= 60) {
                this.fpsDisplay.setAttribute('text', 'color', '#ffff00');
              } else {
                this.fpsDisplay.setAttribute('text', 'color', '#ff0000');
              }
            }
            
            console.log(`Performance: ${fps} FPS`);
            
            this.frameCount = 0;
            this.lastTime = currentTime;
          }
        }
      });
      
      // Frustum Culling Component (Basic Implementation)
      AFRAME.registerComponent('frustum-culling', {
        schema: {
          enabled: { default: true }
        },
        
        init: function() {
          this.camera = document.querySelector('[camera]');
          this.frustum = new THREE.Frustum();
          this.cameraMatrix = new THREE.Matrix4();
        },
        
        tick: function() {
          if (!this.data.enabled || !this.camera) return;
          
          // Update frustum
          const camera = this.camera.components.camera.camera;
          this.cameraMatrix.multiplyMatrices(camera.projectionMatrix, camera.matrixWorldInverse);
          this.frustum.setFromProjectionMatrix(this.cameraMatrix);
          
          // Test if object is in frustum
          const isVisible = this.frustum.intersectsObject(this.el.object3D);
          this.el.setAttribute('visible', isVisible);
        }
      });
      
      // Scene Statistics Component
      AFRAME.registerComponent('scene-stats', {
        init: function() {
          this.statsDisplay = document.querySelector('#stats-display');
          this.updateInterval = 2000; // Update every 2 seconds
          this.lastUpdate = 0;
        },
        
        tick: function() {
          const now = performance.now();
          if (now - this.lastUpdate < this.updateInterval) return;
          
          this.updateStats();
          this.lastUpdate = now;
        },
        
        updateStats: function() {
          const scene = document.querySelector('a-scene');
          const entities = scene.querySelectorAll('a-entity');
          const visibleEntities = Array.from(entities).filter(el => 
            el.getAttribute('visible') !== false
          ).length;
          
          const lodEntities = scene.querySelectorAll('[nanite-lod]');
          const billboardCount = Array.from(lodEntities).filter(el => {
            const lodComponent = el.components['nanite-lod'];
            return lodComponent && lodComponent.currentLOD === 'billboard';
          }).length;
          
          if (this.statsDisplay) {
            const statsText = `Entities: ${entities.length} | Visible: ${visibleEntities} | Billboards: ${billboardCount}`;
            this.statsDisplay.setAttribute('text', 'value', statsText);
          }
        }
      });
      
      // Universal Controls Component (Desktop + VR)
      AFRAME.registerComponent('universal-controls', {
        init: function() {
          // Add WASD controls for desktop
          this.el.setAttribute('wasd-controls', {
            enabled: true,
            acceleration: 15,
            fly: true
          });
          
          // Add look controls
          this.el.setAttribute('look-controls', {
            enabled: true
          });
          
          console.log('üéÆ Universal controls initialized (WASD + VR)');
        }
      });
      
      // VR Movement Component for Quest 3
      AFRAME.registerComponent('vr-movement', {
        schema: {
          speed: { default: 5 },
          rotationSpeed: { default: 45 }
        },
        
        init: function() {
          // Wait for controllers to be ready
          setTimeout(() => {
            this.leftController = document.querySelector('#leftHand');
            this.rightController = document.querySelector('#rightHand');
            this.camera = this.el.querySelector('[camera]');
            
            console.log('üéÆ VR Movement initialized');
            console.log('üéÆ Left controller found:', !!this.leftController);
            console.log('üéÆ Right controller found:', !!this.rightController);
            console.log('üéÆ Camera found:', !!this.camera);
          }, 1000);
          
          // Movement state
          this.moveVector = new THREE.Vector3();
          this.rotationDelta = 0;
        },
        
        tick: function(time, timeDelta) {
          if (!this.leftController || !this.rightController) return;
          
          const deltaSeconds = timeDelta / 1000;
          
          // Get controller states
          const leftGamepad = this.leftController.components['oculus-touch-controls'];
          const rightGamepad = this.rightController.components['oculus-touch-controls'];
          
          if (!leftGamepad || !rightGamepad) return;
          
          // Reset movement
          this.moveVector.set(0, 0, 0);
          this.rotationDelta = 0;
          
          // Left thumbstick - movement
          if (leftGamepad.controllerPresent) {
            const leftStick = leftGamepad.axis;
            if (leftStick && (Math.abs(leftStick[0]) > 0.1 || Math.abs(leftStick[1]) > 0.1)) {
              // Forward/backward (Y axis)
              this.moveVector.z = -leftStick[1] * this.data.speed * deltaSeconds;
              // Left/right strafe (X axis)  
              this.moveVector.x = leftStick[0] * this.data.speed * deltaSeconds;
              
              console.log(`üïπÔ∏è Left stick: ${leftStick[0].toFixed(2)}, ${leftStick[1].toFixed(2)}`);
            }
          }
          
          // Right thumbstick - rotation
          if (rightGamepad.controllerPresent) {
            const rightStick = rightGamepad.axis;
            if (rightStick && Math.abs(rightStick[0]) > 0.1) {
              this.rotationDelta = rightStick[0] * this.data.rotationSpeed * deltaSeconds;
              console.log(`üîÑ Right stick rotation: ${rightStick[0].toFixed(2)}`);
            }
          }
          
          // Apply movement relative to camera direction
          if (this.moveVector.length() > 0) {
            const cameraRotation = this.camera.object3D.rotation;
            this.moveVector.applyEuler(new THREE.Euler(0, cameraRotation.y, 0));
            
            const currentPos = this.el.getAttribute('position');
            this.el.setAttribute('position', {
              x: currentPos.x + this.moveVector.x,
              y: currentPos.y + this.moveVector.y,
              z: currentPos.z + this.moveVector.z
            });
          }
          
          // Apply rotation
          if (Math.abs(this.rotationDelta) > 0) {
            const currentRot = this.el.getAttribute('rotation');
            this.el.setAttribute('rotation', {
              x: currentRot.x,
              y: currentRot.y + this.rotationDelta,
              z: currentRot.z
            });
          }
        }
      });
    </script>

    <a-scene 
      background="color: #0a0a0a"
      renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
      performance-monitor
      scene-stats
      fps-counter="position: top-left"
      webxr="requiredFeatures: local-floor">
      
      <a-assets>
        <!-- Placeholder billboard textures (you can replace with actual textures) -->
        <img id="asteroid-billboard" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iYXN0ZXJvaWQiIGN4PSI1MCUiIGN5PSI1MCUiIHI9IjUwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM4ODg4ODgiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI3MCUiIHN0b3AtY29sb3I9IiM0NDQ0NDQiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjMDAwMDAwIiBzdG9wLW9wYWNpdHk9IjAiLz4KICAgIDwvcmFkaWFsR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMjAwIiBmaWxsPSJ1cmwoI2FzdGVyb2lkKSIvPgo8L3N2Zz4K">
        
        <img id="ship-billboard" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0ic2hpcCIgY3g9IjUwJSIgY3k9IjUwJSIgcj0iNTAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzAwYWFmZiIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjcwJSIgc3RvcC1jb2xvcj0iIzAwNDQ4OCIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMDAwMDAiIHN0b3Atb3BhY2l0eT0iMCIvPgogICAgPC9yYWRpYWxHcmFkaWVudD4KICA8L2RlZnM+CiAgPHBvbHlnb24gcG9pbnRzPSIyNTYsNTAgMzUwLDQwMCAyNTYsMzUwIDE2Miw0MDAiIGZpbGw9InVybCgjc2hpcCkiLz4KPC9zdmc+Cg==">
      </a-assets>

      <!-- Lighting -->
      <a-light type="ambient" intensity="0.4"></a-light>
      <a-light type="directional" position="2 4 5" intensity="0.8" shadow="cast: false"></a-light>

      <!-- Performance Display -->
      <a-text id="fps-display" 
              position="-2 3.5 -5" 
              text="value: FPS: --; align: left; width: 8; color: #ffffff"
              visible="true">
      </a-text>
      
      <a-text id="stats-display" 
              position="-2 3.2 -5" 
              text="value: Stats loading...; align: left; width: 6; color: #cccccc"
              visible="true">
      </a-text>

      <!-- Instructions -->
      <a-text position="0 3.8 -5" 
              text="value: NANITE-STYLE LOD DEMO; align: center; width: 12; color: #00aaff"
              visible="true">
      </a-text>
      
      <a-text position="0 3.5 -5" 
              text="value: Move around to see LOD switching; align: center; width: 8; color: #ffffff"
              visible="true">
      </a-text>

      <!-- Camera Rig with VR Movement -->
      <a-entity id="rig" 
                position="0 1.6 0" 
                vr-movement="speed: 8; rotationSpeed: 60"
                universal-controls>
        <a-camera look-controls="pointerLockEnabled: false">
          <!-- VR Controllers with Movement -->
          <a-entity id="leftHand" 
                   hand-controls="hand: left; handModelStyle: lowPoly; color: #15ACCF"
                   oculus-touch-controls="hand: left"
                   vive-controls="hand: left"
                   windows-motion-controls="hand: left"
                   visible="true">
            <!-- Debug sphere to show controller position -->
            <a-sphere radius="0.05" color="#ff0000" material="emissive: #ff0000"></a-sphere>
          </a-entity>
          
          <a-entity id="rightHand" 
                   hand-controls="hand: right; handModelStyle: lowPoly; color: #15ACCF"
                   oculus-touch-controls="hand: right"
                   vive-controls="hand: right"
                   windows-motion-controls="hand: right"
                   visible="true">
            <!-- Debug sphere to show controller position -->
            <a-sphere radius="0.05" color="#00ff00" material="emissive: #00ff00"></a-sphere>
          </a-entity>
        </a-camera>
      </a-entity>

      <!-- Demo Objects with Nanite-style LOD -->
      
      <!-- Very Close Objects (Should be visible immediately) -->
      <a-entity id="asteroid-1" 
                position="3 2 -3" 
                nanite-lod="billboardTexture: #asteroid-billboard; 
                           nearDistance: 8; 
                           mediumDistance: 15; 
                           farDistance: 30;
                           billboardSize: 4"
                rotation="0 45 0">
      </a-entity>
      
      <a-entity id="asteroid-2" 
                position="-4 1.5 -4" 
                nanite-lod="billboardTexture: #asteroid-billboard; 
                           nearDistance: 8; 
                           mediumDistance: 15; 
                           farDistance: 30;
                           billboardSize: 3"
                rotation="45 0 30">
      </a-entity>
      
      <!-- Medium Distance Objects -->
      <a-entity id="asteroid-3" 
                position="8 3 -8" 
                nanite-lod="billboardTexture: #asteroid-billboard; 
                           nearDistance: 12; 
                           mediumDistance: 20; 
                           farDistance: 40;
                           billboardSize: 6"
                rotation="0 0 45">
      </a-entity>
      
      <a-entity id="asteroid-4" 
                position="-6 2 -10" 
                nanite-lod="billboardTexture: #asteroid-billboard; 
                           nearDistance: 12; 
                           mediumDistance: 20; 
                           farDistance: 40;
                           billboardSize: 5"
                rotation="30 45 0">
      </a-entity>
      
      <!-- Far Distance Objects -->
      <a-entity id="asteroid-5" 
                position="15 4 -15" 
                nanite-lod="billboardTexture: #asteroid-billboard; 
                           nearDistance: 18; 
                           mediumDistance: 30; 
                           farDistance: 60;
                           billboardSize: 8"
                rotation="0 90 0">
      </a-entity>
      
      <a-entity id="asteroid-6" 
                position="-12 3 -12" 
                nanite-lod="billboardTexture: #asteroid-billboard; 
                           nearDistance: 18; 
                           mediumDistance: 30; 
                           farDistance: 60;
                           billboardSize: 7"
                rotation="60 0 30">
      </a-entity>
      
      <!-- Billboard Test Objects -->
      <a-entity id="ship-1" 
                position="25 8 -20" 
                nanite-lod="billboardTexture: #ship-billboard; 
                           nearDistance: 25; 
                           mediumDistance: 40; 
                           farDistance: 80;
                           billboardSize: 10"
                rotation="0 180 0">
      </a-entity>
      
      <a-entity id="ship-2" 
                position="-20 6 -18" 
                nanite-lod="billboardTexture: #ship-billboard; 
                           nearDistance: 25; 
                           mediumDistance: 40; 
                           farDistance: 80;
                           billboardSize: 9"
                rotation="45 270 0">
      </a-entity>
      
      <!-- Debug: Simple visible objects to test -->
      <a-box position="2 2 -2" 
             width="1" height="1" depth="1" 
             color="#ff0000" 
             material="emissive: #330000; emissiveIntensity: 0.5">
      </a-box>
      
      <a-sphere position="-2 2 -2" 
                radius="0.5" 
                color="#00ff00" 
                material="emissive: #003300; emissiveIntensity: 0.5">
      </a-sphere>
      
      <!-- More debug objects at different positions -->
      <a-cylinder position="0 1 -3" 
                  radius="0.3" height="1" 
                  color="#0000ff" 
                  material="emissive: #000033; emissiveIntensity: 0.5">
      </a-cylinder>
      
      <a-cone position="4 1.5 -4" 
              radius-bottom="0.5" height="1" 
              color="#ffff00" 
              material="emissive: #333300; emissiveIntensity: 0.5">
      </a-cone>
      
      <!-- Test LOD object that should be visible -->
      <a-icosahedron position="0 2 -5" 
                     radius="1" 
                     detail="2" 
                     color="#ff00ff" 
                     material="emissive: #330033; emissiveIntensity: 0.5">
      </a-icosahedron>

      <!-- Ground reference -->
      <a-plane position="0 -0.5 0" 
               rotation="-90 0 0" 
               width="200" 
               height="200" 
               color="#111111" 
               material="roughness: 1">
      </a-plane>

      <!-- Skybox -->
      <a-sky color="#001122"></a-sky>
    </a-scene>
</body>
</html>
